!function(e){var t={};function i(a){if(t[a])return t[a].exports;var r=t[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(a,r,function(t){return e[t]}.bind(null,r));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=74)}({46:function(e,t){e.exports='<div class="m-control m-drawfeature-container">\n   <button id="m-button-drawfeature" class="g-cartografia-editar2" title="Dibujar"></button>\n</div>'},47:function(e,t){e.exports='<div class="m-control m-modifyfeature-container">\n   <button id="m-button-modifyfeature" class="g-cartografia-flechas-mover" title="Modificar"></button>\n</div>'},48:function(e,t){e.exports='<div class="m-control m-deletefeature-container">\n   <button id="m-button-deletefeature" class="g-cartografia-papelera" title="Eliminar"></button>\n</div>'},49:function(e,t){e.exports='<div class="m-control m-clearfeature-container">\n   <button id="m-button-clearfeature" class="g-cartografia-flecha-deshacer" title="Limpiar"></button>\n</div>'},50:function(e,t){e.exports='<div class="m-control m-savefeature-container">\n   <button id="m-button-savefeature" class="g-cartografia-guardar" title="Guadar"></button>\n</div>'},51:function(e,t){e.exports='<div class="m-editattribute-content">\n    <table>\n        {{#each properties}}\n        <tr>\n            <td>{{key}}:</td>\n            <td>\n                <input id="{{key}}" type="text" value="{{value}}">\n            </td>\n        </tr>\n        {{/each}}\n    </table>\n    <button id="m-button-editattributeSave" class="save"><i class="g-cartografia-guardar"></i> Guardar</button>\n</div>\n'},52:function(e,t){e.exports='<div class="m-control m-editattribute-container">\n   <button id="m-button-editattribute" class="g-cartografia-texto" title="Editar"></button>\n</div>'},53:function(e){e.exports=JSON.parse('{"url":{"name":"wfstcontrols","separator":","},"constructor":"M.plugin.WFSTControls","parameters":[{"type":"array","properties":[{"type":"simple","position":0},{"type":"simple","position":1},{"type":"simple","position":2},{"type":"simple","position":3},{"type":"simple","position":4}]}],"files":{"ol":{"scripts":["wfstcontrols-3.0.4.ol.min.js"],"styles":["wfstcontrols-3.0.4.min.css"]}},"metadata":{"uuid_plugin":"","uuid_version_plugin":"","version_ficha_metadatos":"","name":"WFSTControls","description":"Tool for editing WFST layers.","text":"","version":"3.0.4","date":"11/10/2019","author":"Junta de Andalucía","org":"Junta de Andalucía","tags":"mapea,plugin","icon":"./facade/assets/icons/icons.svg","buttons":[{"title":"","description":"","querySelector":""},{"title":"","description":"","querySelector":""}],"dependencies":{"modules":["",""],"plugins":[{"uuid":"","name":""}],"services":[{"name":"","description":""}]},"compatibility":["4","5","6"]}}')},72:function(e,t,i){},74:function(e,t,i){"use strict";i.r(t);i(72);class a extends M.impl.Control{constructor(e){super(),this.layer_=e,this.interaction_=null,this.modifiedFeatures=[]}addTo(e,t){this.facadeMap_=e,this.element=t,super.addTo(e,t)}activate(){M.utils.isNullOrEmpty(this.interaction_)?(this.createInteraction_(),this.facadeMap_.getMapImpl().addInteraction(this.interaction_),this.interaction_.setActive(!0)):this.interaction_.setActive(!0)}deactivate(){M.utils.isNullOrEmpty(this.interaction_)?(this.createInteraction_(),this.facadeMap_.getMapImpl().addInteraction(this.interaction_),this.interaction_.setActive(!1)):this.interaction_.setActive(!1)}createInteraction_(){}destroy(){this.facadeMap_.getMapImpl().removeControl(this),this.layer_=null,this.interaction_=null,this.modifiedFeatures=null}}class r extends a{createInteraction_(){const e=this.layer_.getImpl().getOLLayer(),t=e.getSource().getFeatures()[0];let i=null;i=M.utils.isUndefined(t)?new ol.style.Style({fill:new ol.style.Fill({color:"rgba(103, 175, 19, 0.2)",opacity:.4}),stroke:new ol.style.Stroke({color:"#67af13",width:1})}):e.getStyle()(e.getSource().getFeatures()[0])[0];const[a,r]=[i.getFill(),i.getStroke()];let s=new ol.style.Circle({fill:a||r,radius:5,stroke:r});i.getImage()&&(s=i.getImage()),this.interaction_=new ol.interaction.Draw({source:e.getSource(),type:M.geom.parseWFS(this.layer_.geometry),style:new ol.style.Style({image:s,fill:a,stroke:r||new ol.style.Stroke({fill:{color:"#000"}})})}),this.interaction_.on("drawend",e=>{const t=e.feature;this.modifiedFeatures.push(t)},this),this.layer_.on(M.evt.LOAD,this.updateLayerFeatures_.bind(this))}updateLayerFeatures_(){this.facadeMap_.getMapImpl().removeInteraction(this.interaction_),this.interaction_=null}deactivate(){M.utils.isNullOrEmpty(this.interaction_)&&this.createInteraction_();this.facadeMap_.getMapImpl().removeInteraction(this.interaction_),this.interaction_=null}setLayer(e){this.layer_=e}}var s=i(46),o=i.n(s);class n extends M.Control{constructor(e){super(new r(e),n.NAME),this.name=n.NAME,M.utils.isUndefined(r)&&M.Exception("La implementación usada no puede crear controles DrawFeature")}createView(e){return M.template.compileSync(o.a,{jsonp:!0})}getActivationButton(e){return e.querySelector("button#m-button-drawfeature")}equals(e){return e instanceof n}setLayer(e){this.getImpl().setLayer(e)}}n.NAME="drawfeature",n.TEMPLATE="drawfeature.html";class l extends M.impl.Control{constructor(e){super(),this.layer_=e,this.modify=null,this.modifiedFeatures=[],this.currentFeature_=null}activate(){M.utils.isNullOrEmpty(this.modify)&&this.createInteractionModify_(),this.modify.setActive(!0)}deactivate(){M.utils.isNullOrEmpty(this.modify)&&this.createInteractionModify_();this.facadeMap_.getMapImpl().removeInteraction(this.modify),this.modify=null}createInteractionModify_(){const e=this.facadeMap_.getMapImpl(),t=this.layer_.getImpl().getOLLayer();let i=null;const a=t.getSource().getFeatures()[0];i=M.utils.isUndefined(a)?new ol.style.Style({fill:new ol.style.Fill({color:"rgba(103, 175, 19, 0.2)",opacity:.4}),stroke:new ol.style.Stroke({color:"#67af13",width:1})}):t.getStyle()(t.getSource().getFeatures()[0])[0];let r=i.getImage(),s=i.getStroke();const o=i.getFill();null!=r&&(s=r.getStroke());const n=null==s?null:s.clone();null!=n&&n.setColor(M.utils.getRgba(s.getColor())),null==r&&(r=new ol.style.Circle({fill:o||n,radius:5,stroke:s}));const l=new ol.Collection(t.getSource().getFeatures());l.forEach(e=>{e.on("change",e=>{this.currentFeature_=e.target},this)},this),this.modify=new ol.interaction.Modify({features:l,deleteCondition:e=>ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e),style:new ol.style.Style({image:r})}),this.modify.on("modifyend",e=>{const t=this.modifiedFeatures.indexOf(this.currentFeature_);t>=0?this.modifiedFeatures[t]=this.currentFeature_:this.modifiedFeatures.push(this.currentFeature_),this.currentFeature_=null},this),e.addInteraction(this.modify),this.layer_.on(M.evt.LOAD,this.updateLayerFeatures_.bind(this))}updateLayerFeatures_(){this.facadeMap_.getMapImpl().removeInteraction(this.modify),this.modify=null}destroy(){this.facadeMap_.getMapImpl().removeControl(this),this.layer_=null,this.modify=null,this.modifiedFeatures=[]}setLayer(e){this.layer_=e}}var u=i(47),c=i.n(u);class d extends M.Control{constructor(e){super(new l(e),d.NAME),this.name=d.NAME,this.modify=null,M.utils.isUndefined(l)&&M.exception("La implementación usada no puede crear controles ModifyFeature")}createView(e){return M.template.compileSync(c.a,{jsonp:!0})}getActivationButton(e){return e.querySelector("button#m-button-modifyfeature")}equals(e){return e instanceof d}setLayer(e){this.getImpl().setLayer(e)}}d.NAME="modifyfeature",d.TEMPLATE="modifyfeature.html";class p extends M.impl.Control{constructor(e){super(e),this.layer_=e,this.modifiedFeatures=[]}activate(){this.layer_.on(M.evt.SELECT_FEATURES,this.removeFeature_,this)}deactivate(){this.layer_.un(M.evt.SELECT_FEATURES,this.removeFeature_,this)}removeFeature_(e,t){const i=e[0].getImpl().getOLFeature();if(this.layer_.getImpl().getOLLayer().getSource().removeFeature(i),M.utils.isNullOrEmpty(i.getId())){const e=this.facadeMap_.getControls("drawfeature")[0];if(!M.utils.isNullOrEmpty(e)){const t=e.getImpl().modifiedFeatures,a=t.indexOf(i);t.splice(a,1)}}else this.modifiedFeatures.push(i)}setLayer(e){this.layer_=e}}var h=i(48),m=i.n(h);class f extends M.Control{constructor(e){super(new p(e),f.NAME),this.name=f.NAME,M.utils.isUndefined(p)&&M.exception("La implementación usada no puede crear controles DeleteFeature")}createView(e){return M.template.compileSync(m.a,{jsonp:!0})}getActivationButton(e){return e.querySelector("button#m-button-deletefeature")}equals(e){return e instanceof f}setLayer(e){this.getImpl().setLayer(e)}}f.NAME="deletefeature",f.TEMPLATE="deletefeature.html";class _ extends M.impl.Control{constructor(e){super(),this.layer_=e}addTo(e,t){this.facadeMap_=e,super.addTo(e,t)}clear(){const e=this.facadeMap_.getControls("drawfeature")[0];M.utils.isNullOrEmpty(e)||(e.getImpl().modifiedFeatures.length=0,e.deactivate());const t=this.facadeMap_.getControls("modifyfeature")[0];M.utils.isNullOrEmpty(t)||(t.getImpl().modifiedFeatures.length=0,t.deactivate());const i=this.facadeMap_.getControls("deletefeature")[0];M.utils.isNullOrEmpty(i)||(i.getImpl().modifiedFeatures.length=0,i.deactivate());const a=this.facadeMap_.getControls("editattribute")[0];M.utils.isNullOrEmpty(a)||(a.getImpl().editedFeature=null,a.deactivate()),this.layer_.getImpl().refresh(!0)}destroy(){this.layer_=null,this.facadeMap_.getMapImpl().removeControl(this)}setLayer(e){this.layer_=e}}var y=i(49),g=i.n(y);class v extends M.Control{constructor(e){super(new _(e),v.NAME),M.utils.isUndefined(_)&&M.exception("La implementación usada no puede crear controles ClearFeature")}createView(e){return M.template.compileSync(g.a,{jsonp:!0})}manageActivation(e){e.querySelector("button#m-button-clearfeature").addEventListener("click",this.clear_.bind(this))}equals(e){return e instanceof v}clear_(e){e.preventDefault(),this.getImpl().clear()}setLayer(e){this.getImpl().setLayer(e)}}v.NAME="clearfeature",v.TEMPLATE="clearfeature.html";class E extends M.impl.Control{constructor(e){super(),this.layer_=e}addTo(e,t){this.facadeMap_=e,super.addTo(e,t)}saveFeature(){this.layer_.getImpl().getDescribeFeatureType().then(e=>{let t=null,i=null,a=null;const r=this.facadeMap_.getControls(n.NAME)[0];M.utils.isNullOrEmpty(r)||(t=r.getImpl().modifiedFeatures,E.applyDescribeFeatureType.bind(this)(t,e));const s=this.facadeMap_.getControls(d.NAME)[0];M.utils.isNullOrEmpty(s)||(i=s.getImpl().modifiedFeatures,E.applyDescribeFeatureType.bind(this)(i,e));const o=this.facadeMap_.getControls(f.NAME)[0];M.utils.isNullOrEmpty(o)||(a=o.getImpl().modifiedFeatures,E.applyDescribeFeatureType.bind(this)(a,e)),M.utils.isNullOrEmpty(i)||i.forEach(e=>{e.unset("bbox")}),M.utils.isNullOrEmpty(t)||t.forEach(e=>{e.unset("bbox")});let l=this.facadeMap_.getProjection().code;"EPSG:4326"===l&&(l="CRS:84");const u=(new ol.format.WFS).writeTransaction(t,i,a,{featureNS:e.featureNS,featurePrefix:e.featurePrefix,featureType:this.layer_.name,srsName:l,gmlOptions:{srsName:l}}),c=(new XMLSerializer).serializeToString(u);M.remote.post(this.layer_.url,c).then(e=>{this.facadeMap_.getControls(v.NAME)[0].getImpl().clear(),200===e.code&&-1===e.text.indexOf("ExceptionText")&&-1===e.text.indexOf("<error><descripcion>")?M.dialog.success("Se ha guardado correctamente"):401===e.code?M.dialog.error("Ha ocurrido un error al guardar: Usuario no autorizado"):M.dialog.error("Ha ocurrido un error al guardar: ".concat(e.text))})})}destroy(){this.layer_=null,this.facadeMap_.getMapImpl().removeControl(this)}static applyDescribeFeatureType(e,t){const i=this.layer_.getImpl();e.forEach(e=>{const a=e.getGeometryName(),r=e.getGeometry();e.set(t.geometryName,r),e.setGeometryName(t.geometryName),e.setGeometry(r),e.unset(a),!M.utils.isNullOrEmpty(t)&&M.utils.isArray(t.properties)&&t.properties.forEach(t=>{if(!M.utils.isGeometryType(t.localType)){const a=e.getProperties()[t.name]||i.getDefaultValue(t.localType);e.set(t.name,a)}})})}setLayer(e){this.layer_=e}}var b=i(50),F=i.n(b);class S extends M.Control{constructor(e){super(new E(e),S.NAME),this.name=S.NAME,M.utils.isUndefined(E)&&M.exception("La implementación usada no puede crear controles SaveFeature")}createView(e){return this.facadeMap_=e,M.template.compileSync(F.a,{jsonp:!0})}equals(e){return e instanceof S}manageActivation(e){e.querySelector("button#m-button-savefeature").addEventListener("click",this.saveFeature_.bind(this))}saveFeature_(e){e.preventDefault(),this.getImpl().saveFeature()}setLayer(e){this.getImpl().setLayer(e)}}S.NAME="savefeature",S.TEMPLATE="savefeature.html";var w=i(51),T=i.n(w);class A extends M.impl.Control{constructor(e){super(),this.layer_=e,this.editFeature=null}activate(){this.layer_.on(M.evt.SELECT_FEATURES,this.showEditPopup_,this),this.layer_.on(M.evt.UNSELECT_FEATURES,this.unselectFeature_,this)}deactivate(){this.layer_.un(M.evt.SELECT_FEATURES,this.showEditPopup_,this),this.layer_.un(M.evt.UNSELECT_FEATURES,this.unselectFeature_,this)}showEditPopup_(e,t){this.unselectFeature_(),this.editFeature=e[0].getImpl().getOLFeature();const i=t.coord;if(M.utils.isNullOrEmpty(this.editFeature.getId()))this.editFeature=null,M.dialog.info("Debe guardar el elemento previamente");else{this.editFeature.setStyle(A.SELECTED_STYLE);const e={properties:[]};Object.keys(this.editFeature.getProperties()).filter(e=>"geometry"!==e).forEach(t=>{e.properties.push({key:t,value:this.editFeature.get(t)})},this);const t={jsonp:!0,vars:e,parseToHtml:!1},a=M.template.compileSync(T.a,t),r={icon:"g-cartografia-texto",title:I,content:a,listeners:[{selector:"#m-button-editattributeSave",all:!0,type:"click",callback:e=>this.saveAttributes_(e)}]};if(this.popup_=this.facadeMap_.getPopup(),M.utils.isNullOrEmpty(this.popup_))this.popup_=new M.Popup,this.popup_.addTab(r),this.facadeMap_.addPopup(this.popup_,i);else{this.popup_.getTabs().some(e=>e.title!==I)?this.popup_.addTab(r):(this.facadeMap_.removePopup(),this.popup_=new M.Popup,this.popup_.addTab(r),this.facadeMap_.addPopup(this.popup_,i))}}}saveAttributes_(e){this.editFeature.unset("bbox",!0);const t=this.popup_.getContent(),i=e.target,a=this.editFeature.getProperties();i.classList.add("m-savefeature-saving"),Object.keys(a).forEach(e=>{if(null!==t.querySelector("input#"+e)){const i=t.querySelector("input#"+e).value;this.editFeature.set(e,i,!0)}},this),this.layer_.getImpl().getDescribeFeatureType().then(e=>{const t=this.editFeature.getGeometryName(),a=this.editFeature.getGeometry();this.editFeature.setGeometryName(e.geometryName),this.editFeature.setGeometry(a),this.editFeature.unset(t);let r=this.facadeMap_.getProjection().code;"EPSG:4326"===r&&(r="CRS:84");const s=(new ol.format.WFS).writeTransaction(null,[this.editFeature],null,{featureNS:e.featureNS,featurePrefix:e.featurePrefix,featureType:this.layer_.name,srsName:r,gmlOptions:{srsName:r}}),o=(new XMLSerializer).serializeToString(s);this.facadeMap_.removePopup(this.popup_),M.remote.post(this.layer_.url,o).then(e=>{i.classList.remove("m-savefeature-saving"),200===e.code?M.dialog.success("Se ha guardado correctamente el elemento"):M.dialog.error("Ha ocurrido un error al guardar: ".concat(e.text)),this.unselectFeature_()})})}unselectFeature_(){this.facadeMap_.getFeatureHandler().clearSelectedFeatures(),null!==this.editFeature&&(this.editFeature.setStyle(M.impl.layer.WFS.STYLE),this.editFeature=null,this.facadeMap_.removePopup())}destroy(){super.destroy(),M.utils.isNull(this.facadeMap_)||M.utils.isNull(this.facadeMap_.getPopup())||this.facadeMap_.removePopup()}setLayer(e){this.layer_=e}}A.SELECTED_STYLE=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(175, 127, 19, 0.2)"}),stroke:new ol.style.Stroke({color:"#af7f13",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#af7f13"})})});var N=i(52),C=i.n(N);class L extends M.Control{constructor(e){super(new A(e),L.NAME),this.name=L.NAME,M.utils.isUndefined(A)&&M.exception("La implementación usada no puede crear controles EditAttribute")}createView(e){return M.template.compileSync(C.a,{jsonp:!0})}getActivationButton(e){return e.querySelector("button#m-button-editattribute")}equals(e){return e instanceof L}setLayer(e){this.getImpl().setLayer(e)}}L.NAME="editattribute";const I="Editattribute";L.TEMPLATE="editattribute.html";var O=i(53);class x extends M.Plugin{constructor(e,t){super(),this.controls=e,this.controls_=[],this.name=x.NAME,this.layername_=t,this.map_=null,this.drawfeature_=null,this.modifyfeature_=null,this.deletefeature_=null,this.clearfeature_=null,this.savefeature_=null,this.editattibute_=null,this.metadata_=O.metadata,this.numControls_=0,this.numLoadControls_=0}addTo(e){this.map_=e;const t=this.map_.getWFS()[0],i=this.map_.getWFS({name:this.layername_})[0],a=M.utils.isNullOrEmpty(i)?t:i;if(this.panel_=new M.ui.Panel("edit",{collapsible:!0,className:"m-edition",collapsedButtonClass:"g-cartografia-editar",position:M.ui.position.TL,tooltip:"Herramientas de edición"}),M.utils.isNullOrEmpty(a))M.dialog.error(`Los controles <b>${this.controls.join(",")}</b> no se pueden añadir al mapa porque no existe una capa WFS cargada.`);else{let e=!1,t=!1;for(let i=0,r=this.controls.length;i<r;i+=1)"drawfeature"===this.controls[i]?(this.drawfeature_=new n(a),this.controls_.push(this.drawfeature_),e=!0,t=!0,this.numControls_+=1,this.drawfeature_.on(M.evt.ADDED_TO_MAP,()=>{this.checkAddControlsToMap()})):"modifyfeature"===this.controls[i]?(this.modifyfeature_=new d(a),this.controls_.push(this.modifyfeature_),e=!0,t=!0,this.numControls_+=1,this.modifyfeature_.on(M.evt.ADDED_TO_MAP,()=>{this.checkAddControlsToMap()})):"deletefeature"===this.controls[i]?(this.deletefeature_=new f(a),this.controls_.push(this.deletefeature_),e=!0,t=!0,this.numControls_+=1,this.deletefeature_.on(M.evt.ADDED_TO_MAP,()=>{this.checkAddControlsToMap()})):"editattribute"===this.controls[i]&&(this.editattibute_=new L(a),this.controls_.push(this.editattibute_),t=!0,this.numControls_+=1,this.editattibute_.on(M.evt.ADDED_TO_MAP,()=>{this.checkAddControlsToMap()}));e&&(this.savefeature_=new S(a),this.controls_.push(this.savefeature_),this.numControls_+=1,this.savefeature_.on(M.evt.ADDED_TO_MAP,()=>{this.checkAddControlsToMap()})),t&&(this.clearfeature_=new v(a),this.controls_.push(this.clearfeature_),this.numControls_+=1,this.clearfeature_.on(M.evt.ADDED_TO_MAP,()=>{this.checkAddControlsToMap()})),this.panel_.addControls(this.controls_),this.map_.addPanels(this.panel_),this.map_.panel.EDITION=this.panel_}}getControls(){return this.controls_}destroy(){this.map_.removeControls([this.drawfeature_,this.modifyfeature_,this.deletefeature_,this.clearfeature_,this.savefeature_,this.editattibute_]),this.controls=null,this.map_=null,this.drawfeature_=null,this.modifyfeature_=null,this.deletefeature_=null,this.clearfeature_=null,this.savefeature_=null,this.editattibute_=null}setLayer(e){this.layername_=e;const t=this.map_.getWFS({name:this.layername_})[0];if(M.utils.isNullOrEmpty(t))M.dialog.error(`Los capa <b>${e}</b> no es una capa WFS cargada.`);else{const e=[];M.utils.isNullOrEmpty(this.drawfeature_)||e.push(this.drawfeature_),M.utils.isNullOrEmpty(this.modifyfeature_)||e.push(this.modifyfeature_),M.utils.isNullOrEmpty(this.deletefeature_)||e.push(this.deletefeature_),M.utils.isNullOrEmpty(this.clearfeature_)||e.push(this.clearfeature_),M.utils.isNullOrEmpty(this.savefeature_)||e.push(this.savefeature_),M.utils.isNullOrEmpty(this.editattibute_)||e.push(this.editattibute_),this.clearfeature_.getImpl().clear(),e.forEach(e=>e.setLayer(t))}}equals(e){return e instanceof x}getAPIRest(){return"wfstcontrols="+this.controls.join(",")}getMetadata(){return this.metadata_}checkAddControlsToMap(){this.numLoadControls_+=1,this.numLoadControls_===this.numControls_&&this.fire(M.evt.ADDED_TO_MAP)}}x.NAME="wfstcontrols",null==window.M.plugin&&(window.M.plugin={}),window.M.plugin.WFSTControls=x}});