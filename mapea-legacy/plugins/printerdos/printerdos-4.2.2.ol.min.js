(()=>{var t={450:t=>{t.exports='<div class="m-control m-printer-container">\n    \x3c!-- TITLE --\x3e\n    <div class="title">Impresión del mapa</div>\n    \x3c!-- FORM --\x3e\n    <div class="form">\n        \x3c!-- title --\x3e\n        <div class="title">\n            <input type="text" placeholder="Título">\n        </div>\n        \x3c!-- description --\x3e\n        <div class="description">\n            <textarea placeholder="Descripción"></textarea>\n        </div>\n        \x3c!-- layout --\x3e\n        <div class="layout">\n            <label>Plantilla </label>\n            <select>\n                {{#each layouts}}\n                    <option value="{{name}}" {{#if default}} selected{{/if}}>{{name}}</option>\n                {{/each}}\n            </select>\n        </div>\n        \x3c!-- DPI --\x3e\n        <div class="dpi">\n            <label>DPI </label>\n            <select>\n                {{#each dpis}}\n                    <option value="{{value}}" {{#if default}} selected{{/if}}>{{value}}</option>\n                {{/each}}\n            </select>\n        </div>\n        \x3c!-- format --\x3e\n        <div class="format">\n            <label>Formato </label>\n            <select>\n                {{#each format}}\n                    <option value="{{name}}" {{#if default}} selected{{/if}}>{{name}}</option>\n                {{/each}}\n            </select>\n        </div>\n        \x3c!-- force scale --\x3e\n        <div class="forcescale">\n            <label>Forzar escala </label>\n            <input type="checkbox" {{#if forceScale}} checked{{/if}}>\n        </div>\n        \x3c!-- text wrap --\x3e\n        <div class="textwrap">\n            <label>% Ajuste texto</label>\n            <input id=\'inputRange\' type="range" min="0" max="1" step="0.1" value={{textWrap}}>\n            <div id=\'label\'>{{textWrap}}</div>\n        </div>\n    </div>\n    \x3c!-- buttons --\x3e\n    <div class="button">\n        <button class="print"><i class="g-cartografia-impresora"></i> Imprimir</button>\n        <button class="remove"><i class="g-cartografia-papelera"></i> Borrar</button>\n        <button class="cancel"><i class="g-cartografia-cancelar"></i> Cancelar impresión</button>\n    </div>\n    \x3c!-- queue --\x3e\n    <div class="queue">\n        <div class="title">Descargar</div>\n        <ul class="queue-container"></ul>\n    </div>\n    \x3c!-- minimize button --\x3e\n    <div class="minimize" title="Minimizar el control de impresión"></div>\n</div>'}},e={};function i(l){var s=e[l];if(void 0!==s)return s.exports;var n=e[l]={exports:{}};return t[l](n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var l in e)i.o(e,l)&&!i.o(t,l)&&Object.defineProperty(t,l,{enumerable:!0,get:e[l]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";class t extends M.impl.Control{constructor(t={}){super(),this.facadeMap_=null,this.additionalOptsLabel_={},this.labeling_=t.labeling,M.utils.isNullOrEmpty(this.labeling_)?(this.additionalOptsLabel_.conflictResolution="false",this.additionalOptsLabel_.goodnessOfFit=.9):(M.utils.isNullOrEmpty(this.labeling_.allowOverruns)||(this.additionalOptsLabel_.allowOverruns=this.labeling_.allowOverruns),M.utils.isNullOrEmpty(this.labeling_.autoWrap)||(this.additionalOptsLabel_.autoWrap=this.labeling_.autoWrap),M.utils.isNullOrEmpty(this.labeling_.conflictResolution)?this.additionalOptsLabel_.conflictResolution="false":this.additionalOptsLabel_.conflictResolution=this.labeling_.conflictResolution,M.utils.isNullOrEmpty(this.labeling_.followLine)||(this.additionalOptsLabel_.followLine=this.labeling_.followLine),M.utils.isNullOrEmpty(this.labeling_.goodnessOfFit)?this.additionalOptsLabel_.goodnessOfFit=.9:this.additionalOptsLabel_.goodnessOfFit=this.labeling_.goodnessOfFit,M.utils.isNullOrEmpty(this.labeling_.group)||(this.additionalOptsLabel_.group=this.labeling_.group),M.utils.isNullOrEmpty(this.labeling_.maxDisplacement)||(this.additionalOptsLabel_.maxDisplacement=this.labeling_.maxDisplacement),M.utils.isNullOrEmpty(this.labeling_.spaceAround)||(this.additionalOptsLabel_.spaceAround=this.labeling_.spaceAround))}addTo(t,e){this.facadeMap_=t,this.element=e,super.addTo(t,e)}encodeLayer(t){return new Promise(((e,i)=>{t.type===M.layer.type.WMC||(t.type===M.layer.type.KML?e(this.encodeKML(t)):t.type===M.layer.type.WMS?e(this.encodeWMS(t)):t.type===M.layer.type.WFS||t.type===M.layer.type.GeoJSON?e(this.encodeWFS(t)):t.type===M.layer.type.WMTS?this.encodeWMTS(t).then((t=>{e(t)})):t instanceof M.layer.MVT?e(this.encodeMVT(t)):t.type===M.layer.type.MBtiles||(t.type===M.layer.type.OSM?e(this.encodeOSM(t)):t.type===M.layer.type.Mapbox?e(this.encodeMapbox(t)):(M.utils.isNullOrEmpty(t.type)&&M.layer.Vector,e(this.encodeWFS(t)))))}))}encodeLegend(t){let e=null;if(t.displayInLayerSwitcher){e={classes:[]};const i=new RegExp(`.*${M.Layer.LEGEND_DEFAULT}$`),l=new RegExp(`.*${M.Layer.LEGEND_ERROR}$`),s=t.getLegendURL();M.utils.isNullOrEmpty(s)||i.test(s)||l.test(s)||(e.classes[0]={name:t.name,icons:[t.getLegendURL()]},t instanceof M.layer.Vector&&delete e.classes[0].icons)}return e}encodeKML(t){let e=null;const i=t.getImpl().getOL3Layer(),l=i.getSource().getFeatures(),s=t.name,n=i.getOpacity(),o=new ol.format.GeoJSON;let a=this.facadeMap_.getBbox();a=[a.x.min,a.y.min,a.x.max,a.y.max];const r=this.facadeMap_.getMapImpl().getView().getResolution(),u=[];let p=1,c=1,g="";const d={},m={};let y,h,O=1;return l.forEach((t=>{const e=t.getGeometry();let i=t.get("styleUrl");M.utils.isNullOrEmpty(i)||(i=i.replace("#",""));const l=t.getStyle();if(!M.utils.isNullOrEmpty(l)){let s;try{s=l(t,r),Array.isArray(s)&&(s=s[0])}catch(e){s=l.call(t,r)[0]}if(!M.utils.isNullOrEmpty(s)){const l=s.getImage();let n,r=l.getImageSize();M.utils.isNullOrEmpty(r)&&(r=[64,64]),n="multipolygon"===t.getGeometry().getType().toLowerCase()?"polygon":"multipoint"===t.getGeometry().getType().toLowerCase()?"point":t.getGeometry().getType().toLowerCase();const f=s.getStroke();let _;const E={type:n,id:i,externalGraphic:l.getSrc(),graphicHeight:r[0],graphicWidth:r[1],graphicOpacity:l.getOpacity(),strokeWidth:f?f.getWidth():1},b=s.getText&&s.getText();if(M.utils.isNullOrEmpty(b)||(_={type:"text",label:M.utils.isNullOrEmpty(b.getText())?t.get("name"):b.getText(),fontColor:M.utils.isNullOrEmpty(b.getFill())?"":M.utils.rgbToHex(M.utils.isArray(b.getFill().getColor())?`rgba(${b.getFill().getColor().toString()})`:b.getFill().getColor()),fontSize:"11px",fontFamily:"Helvetica, sans-serif",fontWeight:"bold",conflictResolution:this.additionalOptsLabel_.conflictResolution,labelAlign:b.getTextAlign(),labelXOffset:b.getOffsetX(),labelYOffset:b.getOffsetY(),labelOutlineColor:M.utils.isNullOrEmpty(b.getStroke())?"":M.utils.rgbToHex(M.utils.isArray(b.getStroke().getColor())?`rgba(${b.getStroke().getColor().toString()})`:b.getStroke().getColor()),labelOutlineWidth:M.utils.isNullOrEmpty(b.getStroke())?"":b.getStroke().getWidth()},_.fontColor=_.fontColor.slice(0,7),_.labelOutlineColor=_.labelOutlineColor.slice(0,7),_=this.addAdditionalLabelOptions(_)),y=`draw${O}`,!M.utils.isNullOrEmpty(e)&&e.intersectsExtent(a)||!M.utils.isNullOrEmpty(b)){const i=JSON.stringify(E),l=JSON.stringify(_);let s=d[i],n=m[l];if(M.utils.isUndefined(s)||M.utils.isUndefined(n)){const t=[];let o=0;if(!M.utils.isNullOrEmpty(e)&&e.intersectsExtent(a)&&M.utils.isUndefined(s)&&(s=c,d[i]=s,o=1,t.push(i),c+=1,O+=1),!M.utils.isNullOrEmpty(b)&&M.utils.isUndefined(n)&&(n=p,m[l]=n,t.push(l),p+=1,0===o&&(O+=1,t.push(i))),void 0===s&&(s=0),void 0===n&&(n=0),h=`"[_gx_style ='${s+n}']"`,!M.utils.isNullOrEmpty(t)){const e=` ${h}:{"symbolizers": [${t}]}`;g+=""!==g?`,${e}`:`{${e},"version":"2"`}}const r=o.writeFeatureObject(t);r.properties={_gx_style:s+n,name:y},u.push(r)}}}}),this),g=""!==g?JSON.parse(g.concat("}")):{"*":{symbolizers:[]},version:"2"},e={type:"Vector",style:g,styleProperty:"_gx_style",geoJson:{type:"FeatureCollection",features:u},name:s,opacity:n},e}encodeWMS(t){let e=null;const i=t.getImpl().getOL3Layer(),l=t.url,s=i.getOpacity(),n=i.getSource().getParams(),o=[n.LAYERS],a=n.FORMAT,r=[n.STYLES];if(e={baseURL:l,opacity:s,type:"WMS",layers:o.join(",").split(","),format:a||"image/jpeg",styles:r.join(",").split(",")},t._updateNoCache){t._updateNoCache();const i=t.getNoCacheName(),l=t.getNoCacheUrl();M.utils.isNullOrEmpty(i)||M.utils.isNullOrEmpty(l)||(e.layers=[i],e.baseURL=l)}else{const i=t.getNoChacheName(),l=t.getNoChacheUrl();M.utils.isNullOrEmpty(i)||M.utils.isNullOrEmpty(l)||(e.layers=[i],e.baseURL=l)}return e.customParams={},Object.keys(n).forEach((t=>{-1!=="iswmc,transparent".indexOf(t.toLowerCase())&&(e.customParams[t]=n[t])})),e}encodeWFS(t){let e=null,i=!0;if((t.getStyle()instanceof M.style.Chart||t.getStyle()instanceof M.style.Cluster&&t.getStyle().getOldStyle()instanceof M.style.Chart)&&(i=!1),i){const i=this.facadeMap_.getProjection(),l=t.getImpl().getOL3Layer();let s=null;s=t.type===M.layer.type.MVT?t.getFeatures():l.getSource().getFeatures();const n=t.name,o=l.getOpacity(),a=l.getStyle(),r=new ol.format.GeoJSON;let u=this.facadeMap_.getBbox();u=[u.x.min,u.y.min,u.x.max,u.y.max];const p=this.facadeMap_.getMapImpl().getView().getResolution(),c=[];let g,d,m=1,y=1,h=1,O="";const f={},_={};s.forEach((e=>{const l=e.getGeometry();let s;const n=e.getStyle();M.utils.isNullOrEmpty(n)?M.utils.isNullOrEmpty(a)||(s=a):s=n,s instanceof Function&&(s=s.call(s,e,p));let o=null;if(s instanceof Array&&(s.length>1?(o=M.utils.isNullOrEmpty(s[1])||M.utils.isNullOrEmpty(s[1].getImage())||!s[1].getImage().getGlyph?null:s[1].getImage(),s=!M.utils.isNullOrEmpty(s[1].getImage())&&s[1].getImage().getSrc?s[1]:s[0]):s=s[0]),!M.utils.isNullOrEmpty(s)){const n=s.getImage(),a=M.utils.isNullOrEmpty(n)?[0,0]:n.getImageSize()||[24,24];let p,E=s.getText();M.utils.isNullOrEmpty(E)&&!M.utils.isNullOrEmpty(s.textPath)&&(E=s.textPath),p="multipolygon"===e.getGeometry().getType().toLowerCase()?"polygon":"multipoint"===e.getGeometry().getType().toLowerCase()?"point":"multilinestring"===e.getGeometry().getType().toLowerCase()?"line":e.getGeometry().getType().toLowerCase();const b=M.utils.isNullOrEmpty(n)?s.getStroke():n.getStroke&&n.getStroke(),x=M.utils.isNullOrEmpty(n)?s.getFill():n.getFill&&n.getFill();let N;const L=M.utils.isNullOrEmpty(n)?"":n.getRadius&&n.getRadius(),S={type:p,fillColor:M.utils.isNullOrEmpty(x)?"#000000":M.utils.rgbaToHex(x.getColor()).slice(0,7),fillOpacity:M.utils.isNullOrEmpty(x)?0:M.utils.getOpacityFromRgba(x.getColor()),strokeColor:M.utils.isNullOrEmpty(b)?"#000000":M.utils.rgbaToHex(b.getColor()),strokeOpacity:M.utils.isNullOrEmpty(b)?0:M.utils.getOpacityFromRgba(b.getColor()),strokeWidth:M.utils.isNullOrEmpty(b)?0:b.getWidth&&b.getWidth(),pointRadius:M.utils.isNullOrEmpty(n)?"":n.getRadius&&n.getRadius(),externalGraphic:M.utils.isNullOrEmpty(n)?"":n.getSrc&&n.getSrc(),graphicHeight:a[0],graphicWidth:a[1]};Number.isNaN(L)&&(S.fillOpacity=0,S.strokeOpacity=0,S.pointRadius=0);const v=!M.utils.isNullOrEmpty(o)&&o.getImage?o.getImage():null;if(M.utils.isNullOrEmpty(v)||(o.getRadius&&o.getRadius()&&(S.pointRadius=o.getRadius&&o.getRadius()),o.getOpacity&&o.getOpacity()&&(S.graphicOpacity=o.getOpacity()),S.externalGraphic=v.toDataURL()),!M.utils.isNullOrEmpty(E)){let t=E.getTextAlign(),e=E.getTextBaseline(),i="";M.utils.isNullOrEmpty(t)||(t=t===M.style.align.LEFT?"l":t===M.style.align.RIGHT?"r":t===M.style.align.CENTER?"c":""),M.utils.isNullOrEmpty(e)||(e=e===M.style.baseline.BOTTOM?"b":e===M.style.baseline.MIDDLE?"m":e===M.style.baseline.TOP?"t":""),M.utils.isNullOrEmpty(t)||M.utils.isNullOrEmpty(e)||(i=t.concat(e));const l=E.getFont(),s=!M.utils.isNullOrEmpty(l)&&l.indexOf("bold")>-1?"bold":"normal";let n="11px";if(!M.utils.isNullOrEmpty(l)){const t=l.substr(0,l.indexOf("px"));if(!M.utils.isNullOrEmpty(t)){const e=t.lastIndexOf(" ");n=e>-1?t.substr(e,t.length).trim().concat("px"):t.concat("px")}}N={type:"text",label:E.getText()||"",fontColor:M.utils.isNullOrEmpty(E.getFill())?"#000000":M.utils.rgbToHex(E.getFill().getColor()),fontSize:n,fontFamily:"Helvetica, sans-serif",fontStyle:"normal",fontWeight:s,conflictResolution:this.additionalOptsLabel_.conflictResolution,labelXOffset:E.getOffsetX(),labelYOffset:E.getOffsetY(),fillColor:S.fillColor||"#FF0000",fillOpacity:S.fillOpacity||1,labelOutlineColor:M.utils.isNullOrEmpty(E.getStroke())?"":M.utils.rgbToHex(E.getStroke().getColor()||"#FF0000"),labelOutlineWidth:M.utils.isNullOrEmpty(E.getStroke())?"":E.getStroke().getWidth(),labelAlign:i},N=this.addAdditionalLabelOptions(N)}if(g=`draw${m}`,!M.utils.isNullOrEmpty(l)&&l.intersectsExtent(u)||!M.utils.isNullOrEmpty(E)){const s=JSON.stringify(S),n=JSON.stringify(N);let o,a=f[s],p=_[n];if(M.utils.isUndefined(a)||M.utils.isUndefined(p)){const i=[];let o=0;if(!M.utils.isNullOrEmpty(l)&&l.intersectsExtent(u)&&M.utils.isUndefined(a)&&(a=h,f[s]=a,o=1,i.push(s),h+=1,m+=1),!M.utils.isNullOrEmpty(E)&&M.utils.isUndefined(p)&&(p=y,_[n]=p,i.push(n),y+=1,0===o&&(m+=1,i.push(s))),void 0===a&&(a=0),void 0===p&&(p=0),d=`"[_gx_style ='${a+p}']"`,!M.utils.isNullOrEmpty(i)){let l=` ${d}:{"symbolizers": [${i}]}`;if(t.getStyle()instanceof M.style.Proportional){const t=e.getGeometry().getType().toLocaleLowerCase();t.indexOf("polygon")>=0?l=l.replace("polygon","point"):t.indexOf("line")>=0&&(l=l.replace("line","point"))}l=l.replace("linestring","line"),O+=""!==O?`,${l}`:`{${l},"version":"2"`}}o="EPSG:3857"!==i.code&&this.facadeMap_.getLayers().some((t=>t.type===M.layer.type.OSM||t.type===M.layer.type.Mapbox))?r.writeFeatureObject(e,{featureProjection:i.code,dataProjection:"EPSG:3857"}):r.writeFeatureObject(e),o.properties={_gx_style:a+p,name:g},c.push(o)}}}),this),O=""!==O?JSON.parse(O.concat("}")):{"*":{symbolizers:[]},version:"2"},e={type:"Vector",style:O,styleProperty:"_gx_style",geoJson:{type:"FeatureCollection",features:c},name:n,opacity:o}}return e}encodeMVT(t){let e=null,i=!0;if((t.getStyle()instanceof M.style.Chart||t.getStyle()instanceof M.style.Cluster&&t.getStyle().getOldStyle()instanceof M.style.Chart)&&(i=!1),i){const i=t.getImpl().getOL3Layer(),l=t.getFeatures(),s=t.name,n=i.getOpacity(),o=i.getStyle();let a=this.facadeMap_.getBbox();a=[a.x.min,a.y.min,a.x.max,a.y.max];const r=this.facadeMap_.getMapImpl().getView().getResolution(),u=[];let p,c,g=1,d=1,m=1,y="";const h={},O={};l.forEach((e=>{const i=e.getImpl().getOLFeature().getGeometry();let l;const s=e.getImpl().getOLFeature().getStyleFunction();M.utils.isNullOrEmpty(s)?M.utils.isNullOrEmpty(o)||(l=o):l=s,l instanceof Function&&(l=l.call(l,e.getImpl().getOLFeature(),r));let n=null;if(l instanceof Array&&(l.length>1?(n=M.utils.isNullOrEmpty(l[1])||M.utils.isNullOrEmpty(l[1].getImage())||!l[1].getImage().getGlyph?null:l[1].getImage(),l=!M.utils.isNullOrEmpty(l[1].getImage())&&l[1].getImage().getSrc?l[1]:l[0]):l=l[0]),!M.utils.isNullOrEmpty(l)){const s=l.getImage(),o=M.utils.isNullOrEmpty(s)?[0,0]:s.getImageSize()||[24,24];let r,f=l.getText();M.utils.isNullOrEmpty(f)&&!M.utils.isNullOrEmpty(l.textPath)&&(f=l.textPath),r="multipolygon"===i.getType().toLowerCase()?"polygon":"multipoint"===i.getType().toLowerCase()?"point":"multilinestring"===i.getType().toLowerCase()?"line":i.getType().toLowerCase();const _=M.utils.isNullOrEmpty(s)?l.getStroke():s.getStroke&&s.getStroke(),E=M.utils.isNullOrEmpty(s)?l.getFill():s.getFill&&s.getFill();let b;const x=M.utils.isNullOrEmpty(s)?"":s.getRadius&&s.getRadius(),N={type:r,fillColor:M.utils.isNullOrEmpty(E)?"#000000":M.utils.rgbaToHex(E.getColor()).slice(0,7),fillOpacity:M.utils.isNullOrEmpty(E)?0:M.utils.getOpacityFromRgba(E.getColor()),strokeColor:M.utils.isNullOrEmpty(_)?"#000000":M.utils.rgbaToHex(_.getColor()),strokeOpacity:M.utils.isNullOrEmpty(_)?0:M.utils.getOpacityFromRgba(_.getColor()),strokeWidth:M.utils.isNullOrEmpty(_)?0:_.getWidth&&_.getWidth(),pointRadius:M.utils.isNullOrEmpty(s)?"":s.getRadius&&s.getRadius(),externalGraphic:M.utils.isNullOrEmpty(s)?"":s.getSrc&&s.getSrc(),graphicHeight:o[0],graphicWidth:o[1]};Number.isNaN(x)&&(N.fillOpacity=0,N.strokeOpacity=0,N.pointRadius=0);const L=!M.utils.isNullOrEmpty(n)&&n.getImage?n.getImage():null;if(M.utils.isNullOrEmpty(L)||(n.getRadius&&n.getRadius()&&(N.pointRadius=n.getRadius&&n.getRadius()),n.getOpacity&&n.getOpacity()&&(N.graphicOpacity=n.getOpacity()),N.externalGraphic=L.toDataURL()),!M.utils.isNullOrEmpty(f)){let t=f.getTextAlign(),e=f.getTextBaseline(),i="";M.utils.isNullOrEmpty(t)||(t=t===M.style.align.LEFT?"l":t===M.style.align.RIGHT?"r":t===M.style.align.CENTER?"c":""),M.utils.isNullOrEmpty(e)||(e=e===M.style.baseline.BOTTOM?"b":e===M.style.baseline.MIDDLE?"m":e===M.style.baseline.TOP?"t":""),M.utils.isNullOrEmpty(t)||M.utils.isNullOrEmpty(e)||(i=t.concat(e));const l=f.getFont(),s=!M.utils.isNullOrEmpty(l)&&l.indexOf("bold")>-1?"bold":"normal";let n="11px";if(!M.utils.isNullOrEmpty(l)){const t=l.substr(0,l.indexOf("px"));if(!M.utils.isNullOrEmpty(t)){const e=t.lastIndexOf(" ");n=e>-1?t.substr(e,t.length).trim().concat("px"):t.concat("px")}}b={type:"text",label:f.getText()||"",fontColor:M.utils.isNullOrEmpty(f.getFill())?"#000000":M.utils.rgbToHex(f.getFill().getColor()),fontSize:n,fontFamily:"Helvetica, sans-serif",fontStyle:"normal",fontWeight:s,conflictResolution:this.additionalOptsLabel_.conflictResolution,labelXOffset:f.getOffsetX(),labelYOffset:f.getOffsetY(),fillColor:N.fillColor||"#FF0000",fillOpacity:N.fillOpacity||1,labelOutlineColor:M.utils.isNullOrEmpty(f.getStroke())?"":M.utils.rgbToHex(f.getStroke().getColor()||"#FF0000"),labelOutlineWidth:M.utils.isNullOrEmpty(f.getStroke())?"":f.getStroke().getWidth(),labelAlign:i},b=this.addAdditionalLabelOptions(b)}p=`draw${g}`;const S=i.getExtent();if(!M.utils.isNullOrEmpty(i)&&ol.extent.intersects(a,S)||!M.utils.isNullOrEmpty(f)){const l=JSON.stringify(N),s=JSON.stringify(b);let n=h[l],o=O[s];if(M.utils.isUndefined(n)||M.utils.isUndefined(o)){const r=[];let u=0;if(!M.utils.isNullOrEmpty(i)&&ol.extent.intersects(a,S)&&M.utils.isUndefined(n)&&(n=m,h[l]=n,u=1,r.push(l),m+=1,g+=1),!M.utils.isNullOrEmpty(f)&&M.utils.isUndefined(o)&&(o=d,O[s]=o,r.push(s),d+=1,0===u&&(g+=1,r.push(l))),void 0===n&&(n=0),void 0===o&&(o=0),c=`"[_gx_style ='${n+o}']"`,!M.utils.isNullOrEmpty(r)){let i=` ${c}:{"symbolizers": [${r}]}`;if(t.getStyle()instanceof M.style.Proportional){const t=e.getGeometry().getType().toLocaleLowerCase();t.indexOf("polygon")>=0?i=i.replace("polygon","point"):t.indexOf("line")>=0&&(i=i.replace("line","point"))}i=i.replace("linestring","line"),y+=""!==y?`,${i}`:`{${i},"version":"2"`}}let _=i.getFlatCoordinates();if(_=this.inflCoordArray(r,_.slice(),0,i.getEnds(),2),_.length>0){const t={id:e.getId(),type:"Feature",geometry:{type:i.getType(),coordinates:_}};t.properties={_gx_style:n+o,name:p},u.push(t)}}}}),this),y=""!==y?JSON.parse(y.concat("}")):{"*":{symbolizers:[]},version:"2"},e={type:"Vector",style:y,styleProperty:"_gx_style",geoJson:{type:"FeatureCollection",features:u},name:s,opacity:n}}return e}inflCoordinates(t,e,i,l,s){const n=void 0!==s?s:[];let o=0;for(let s=e;s<i;s+=l)n[o++]=t.slice(s,s+l);return n.length=o,n}inflCoordArray(t,e,i,l,s,n){let o=void 0!==n?n:[],a=0;for(let n=0,r=l.length;n<r;++n){const r=l[n],u=this.inflCoordinates(e,i,r,s,o[a]);("point"===t||("line"===t||"linestring"===t)&&u.length>=2||"polygon"===t&&u.length>3)&&(o[a++]=u),i=r}return o.length=a,"line"!==t&&"linestring"!==t||1!==o.length||(o=o[0]),o}inflateMultiCoordinatesArray(t,e,i,l,s){const n=void 0!==s?s:[];let o=0;for(let s=0,a=i.length;s<a;++s){const a=i[s];n[o++]=this.inflCoordArray(t,e,a,l,n[o]),e=a[a.length-1]}return n.length=o,n}encodeWMTS(t){const e=this.facadeMap_.getZoom(),i=t.getImpl(),l=i.getOL3Layer(),s=l.getSource(),n=s.getTileGrid(),o=M.utils.isNullOrEmpty(s.getStyle)?"default":s.getStyle(),a=t.url,r=t.name,u=l.getOpacity(),p=s.getRequestEncoding(),c=i.tiled,g=l.getExtent(),d={},m=s.getMatrixSet(),y=n.getTileSize(e),h=n.getResolutions();return t.getImpl().getCapabilities().then((t=>{const e=t.Contents.TileMatrixSet.filter((t=>t.Identifier===m))[0];return{baseURL:a,opacity:u,singleTile:!c,type:"WMTS",layer:r,requestEncoding:p,tileSize:y,style:M.utils.isNullOrEmpty(o)?"default":o,rotation:0,imageFormat:"image/png",dimensionParams:{},dimensions:[],params:d,version:"1.0.0",maxExtent:g,matrixSet:m,matrices:e.TileMatrix.map(((t,e)=>({identifier:t.Identifier,matrixSize:[t.MatrixWidth,t.MatrixHeight],scaleDenominator:t.ScaleDenominator,tileSize:[t.TileWidth,t.TileHeight],topLeftCorner:t.TopLeftCorner}))),resolutions:h}}))}encodeOSM(t){let e=null;const i=t.getImpl(),l=i.getOL3Layer(),s=l.getSource().getTileGrid(),n=t.url||"http://tile.openstreetmap.org/",o=t.name,a=l.getOpacity(),r=i.tiled,u=s.getExtent(),p=s.getTileSize();return e={baseURL:n,opacity:a,singleTile:!r,layer:o,maxExtent:u,tileSize:[p,p],resolutions:s.getResolutions(),type:"OSM",imageExtension:"png"},e}encodeMapbox(t){let e=null;const i=t.getImpl().getOL3Layer(),l=i.getSource().getTileGrid(),s=M.utils.concatUrlPaths([M.config.MAPBOX_URL,t.name]),n=i.getOpacity(),o=l.getExtent(),a=l.getTileSize(),r=l.getResolutions(),u={};return u[M.config.MAPBOX_TOKEN_NAME]=M.config.MAPBOX_TOKEN_VALUE,e={opacity:n,baseURL:s,customParams:u,maxExtent:o,tileSize:[a,a],resolutions:r,extension:M.config.MAPBOX_EXTENSION,type:"osm",path_format:"/${z}/${x}/${y}.png"},e}transformExt(t,e,i){return ol.proj.transformExtent(t,e,i)}addAdditionalLabelOptions(t){const e=t;return M.utils.isNullOrEmpty(this.additionalOptsLabel_.allowOverruns)||(e.allowOverruns=this.additionalOptsLabel_.allowOverruns),M.utils.isNullOrEmpty(this.additionalOptsLabel_.autoWrap)||(e.autoWrap=this.additionalOptsLabel_.autoWrap),M.utils.isNullOrEmpty(this.additionalOptsLabel_.followLine)||(e.followLine=this.additionalOptsLabel_.followLine),M.utils.isNullOrEmpty(this.additionalOptsLabel_.goodnessOfFit)||(e.goodnessOfFit=this.additionalOptsLabel_.goodnessOfFit),M.utils.isNullOrEmpty(this.additionalOptsLabel_.group)||(e.group=this.additionalOptsLabel_.group),M.utils.isNullOrEmpty(this.additionalOptsLabel_.maxDisplacement)||(e.maxDisplacement=this.additionalOptsLabel_.maxDisplacement),M.utils.isNullOrEmpty(this.additionalOptsLabel_.spaceAround)||(e.spaceAround=this.additionalOptsLabel_.spaceAround),e}setGoodnessOfFit(t){this.additionalOptsLabel_.goodnessOfFit=t}destroy(){this.facadeMap_.getMapImpl().removeControl(this),this.facadeMap_=null}}var e=i(450),l=i.n(e);const s="Error de conexión",n="No se ha podido conectar con el servicio de impresión";class o extends M.Control{constructor(e,i,l){super(new t(l),o.NAME),M.utils.isUndefined(t)&&M.exception("La implementación usada no puede crear controles Printer"),M.utils.isUndefined(t.prototype.encodeLayer)&&M.exception("La implementación usada no posee el método encodeLayer"),M.utils.isUndefined(t.prototype.encodeLegend)&&M.exception("La implementación usada no posee el método encodeLegend"),this.url_=e,this.ref_=null,this.printing_=!1,this.inputTitle_=null,this.areaDescription_=null,this.layout_=null,this.format_=null,this.dpi_=null,this.forceScale_=null,this.textWrap_=null,this.params_=i||{},this.queueContainer_=null,this.capabilitiesPromise_=null,this.connectionTimeout_=l.connectionTimeout||15,this.loadingService=!0,this.errorService=!1,this.outputFormats_=Array.isArray(l.outputFormats)?l.outputFormats:["pdf","png","jpg"],this.options_=l||{},M.utils.isNullOrEmpty(this.options_.layout)&&(this.options_.layout=M.config.geoprint.TEMPLATE),M.utils.isNullOrEmpty(this.options_.dpi)&&(this.options_.dpi=M.config.geoprint.DPI),M.utils.isNullOrEmpty(this.options_.format)&&(this.options_.format=M.config.geoprint.FORMAT),M.utils.isNullOrEmpty(this.options_.forceScale)&&(this.options_.forceScale=M.config.geoprint.FORCE_SCALE),M.utils.isNullOrEmpty(this.options_.legend)&&(this.options_.legend=M.config.geoprint.LEGEND),M.utils.isNullOrEmpty(this.options_.labeling)?this.options_.labeling={goodnessOfFit:.9}:M.utils.isNullOrEmpty(this.options_.labeling.goodnessOfFit)&&(this.options_.labeling.goodnessOfFit=.9)}getStatus(t,e){M.remote.get(t).then((i=>{const l=JSON.parse(i.text),{status:s}=l;"finished"===s?e():"error"===s?(e(),M.dialog.error("Se ha producido un error en la impresión")):!1===this.printing_?(M.dialog.error("Se ha cancelado la impresión"),this.queueContainer_.lastChild.remove()):setTimeout((()=>this.getStatus(t,e)),1e3)}))}open(){if(this.loadingService)M.dialog.error("El servicio aún no ha cargado","Servicio cargando");else if(this.errorService)M.dialog.error(n,s);else{const t=this.getPanel().getTemplatePanel(),e=this.getPanel().getButtonPanel();t.classList.remove("collapsed"),e.classList.remove("g-cartografia-impresora"),t.classList.add("opened"),e.classList.add("g-cartografia-flecha-derecha"),this.getPanel().setCollapsed(!1),this.getPanel().fire(M.evt.SHOW)}}createView(t){return this.getPanel().open=this.open.bind(this),new Promise(((t,e)=>{this.getCapabilities().then((e=>{const i=e;let s,n,o=0;for(i.layouts=i.layouts.filter((t=>!t.name.endsWith("jpg"))),o=0,s=i.layouts.length;o<s;o+=1){const t=i.layouts[o];if(t.name===this.options_.layout){t.default=!0;break}}for(i.dpis=[],o=0,s=i.layouts[0].attributes.length;o<s;o+=1)null!=i.layouts[0].attributes[o].clientInfo&&(n=i.layouts[0].attributes[o]);for(o=0,s=n.clientInfo.dpiSuggestions.length;o<s;o+=1){const t=n.clientInfo.dpiSuggestions[o],e={value:t};t===this.options_.dpi&&(e.default=!0),i.dpis.push(e)}Array.isArray(i.formats)&&(this.outputFormats_=i.formats),i.format=this.outputFormats_.map((t=>{const e={name:t};return t===this.options_.format&&(e.default=!0),e})),M.template.compileSync||(M.template.compileSync=(t,e)=>{let i,l,s={};M.utils.isUndefined(e)||(s=M.utils.extends(s,e.vars),l=e.parseToHtml);const n=Handlebars.compile(t)(s);return i=!1!==l?M.utils.stringToHtml(n):n,i}),i.forceScale=this.options_.forceScale,i.textWrap=this.options_.labeling.goodnessOfFit;const a=M.template.compileSync(l(),{jsonp:!0,vars:i});this.addEvents(a),this.loadingService=!1,t(a)})).catch((t=>{this.loadingService=!1,this.errorService=!0,M.dialog.error(n,s)}))}))}addEvents(t){this.element_=t,this.inputTitle_=this.element_.querySelector(".form div.title > input"),this.areaDescription_=this.element_.querySelector(".form div.description > textarea");const e=this.element_.querySelector(".form div.layout > select");e.addEventListener("change",(t=>{const i=e.value;this.setLayout({value:i,name:i})}));const i=e.value;this.setLayout({value:i,name:i});const l=this.element_.querySelector(".form div.dpi > select");l.addEventListener("change",(t=>{const e=l.value;this.setDpi({value:e,name:e})}));const s=l.value;this.setDpi({value:s,name:s});const n=this.element_.querySelector(".form div.format > select");n.addEventListener("change",(t=>{this.setFormat(n.value)})),this.setFormat(n.value);const o=this.element_.querySelector(".form div.forcescale > input");o.addEventListener("click",(t=>{this.setForceScale(!0===o.checked)})),this.setForceScale(!0===o.checked);const a=this.element_.querySelector(".form div.textwrap > input");a.addEventListener("change",(t=>{this.setTextWrap(parseFloat(a.value))})),this.element_.querySelector(".button > button.print").addEventListener("click",this.printClick_.bind(this)),this.element_.querySelector(".button > button.cancel").addEventListener("click",this.cancelClick_.bind(this)),this.element_.querySelector(".button > button.remove").addEventListener("click",(t=>{t.preventDefault(),this.inputTitle_.value="",this.areaDescription_.value="",e.value=this.options_.layout,l.value=this.options_.dpi,n.value=this.options_.format,o.checked=this.options_.forceScale,a.value=this.options_.labeling.textWrap;const i=document.createEvent("HTMLEvents");i.initEvent("change");const s=document.createEvent("HTMLEvents");s.initEvent("click"),e.dispatchEvent(i),l.dispatchEvent(i),n.dispatchEvent(i),o.dispatchEvent(s),a.dispatchEvent(i),Array.prototype.forEach.apply(this.queueContainer_.children,[t=>{t.removeEventListener("click",this.dowloadPrint)},this]),this.queueContainer_.innerHTML=""})),this.queueContainer_=this.element_.querySelector(".queue > ul.queue-container"),M.utils.enableTouchScroll(this.queueContainer_)}setLayout(t){this.layout_=t}setFormat(t){this.format_=t}setDpi(t){this.dpi_=t}setForceScale(t){this.forceScale_=t}setTextWrap(t){this.textwrap_=t,this.getImpl().setGoodnessOfFit(t);const e=this.getPanel().getTemplatePanel(),i=e.querySelector("#label"),l=e.querySelector("#inputRange");i.innerHTML=l.value}printClick_(t){t.preventDefault(),this.getPrintData().then((t=>{let e=M.utils.concatUrlPaths([this.url_,`report.${t.outputFormat}`]);const i=this.createQueueElement();this.queueContainer_.appendChild(i),i.classList.add(o.LOADING_CLASS),e=M.utils.addParameters(e,"mapeaop=geoprint"),M.remote.post(e,t).then((t=>{let e=t;const l=JSON.parse(e.text);this.ref_=l.ref;const s=M.utils.concatUrlPaths([this.params_.urlApplication,"print/status",`${this.ref_}.json`]);if(this.printing_=!0,this.getStatus(s,(()=>i.classList.remove(o.LOADING_CLASS))),200===e.code){let t;try{e=JSON.parse(e.text);const i=e.downloadURL.split("@")[1],l=e.downloadURL.substring(e.downloadURL.indexOf("/print"),e.downloadURL.length);t=M.utils.concatUrlPaths([this.params_.urlApplication,`${l};GEOPRID=.${i}`])}catch(t){M.exception(t)}i.setAttribute(o.DOWNLOAD_ATTR_NAME,t),i.addEventListener("click",this.dowloadPrint)}else M.dialog.error("Se ha producido un error en la impresión")}))}))}cancelClick_(t){t.preventDefault(),this.printing_=!1}getCapabilities(){return M.utils.isNullOrEmpty(this.capabilitiesPromise_)&&(this.capabilitiesPromise_=new Promise(((t,e)=>{setTimeout((()=>{const t=new Error("CONNECTION TIMEOUT");e(t)}),1e3*this.connectionTimeout_);const i=M.utils.concatUrlPaths([this.url_,"capabilities.json"]);M.remote.get(i).then((e=>{let i={};try{i=JSON.parse(e.text)}catch(t){M.exception(t)}t(i)}))}))),this.capabilitiesPromise_}getPrintData(){const t=this.inputTitle_.value,e=this.areaDescription_.value,i=this.map_.getProjection().code;let l=this.layout_.name;const s=this.dpi_.value,n=this.format_,o=this.map_.getCenter(),a=this.params_.parameters,r=this.options_.legend;"jpg"===n&&(l+=" jpg");const u=M.utils.extend({layout:l,outputFormat:n,attributes:{title:t,description:e,epsg:i,map:{useAdjustBounds:!0,projection:i,dpi:s}}},this.params_.layout);return this.encodeLayers().then((t=>{if(u.attributes.map.layers=t,u.attributes=Object.assign(u.attributes,a),r){const t=[],e=this.encodeLegends();for(let i=0,l=e.length;i<l;i+=1)if(!M.utils.isNullOrEmpty(e[i].classes[0])){const l={name:e[i].classes[0].name,icons:e[i].classes[0].icons};t.push(l)}u.attributes.legend={classes:t}}if("EPSG:3857"!==i&&this.map_.getLayers().some((t=>t.type===M.layer.type.OSM||t.type===M.layer.type.Mapbox))&&(u.attributes.map.projection="EPSG:3857"),!1===this.forceScale_){const t=this.map_.getBbox();u.attributes.map.bbox=[t.x.min,t.y.min,t.x.max,t.y.max],"EPSG:3857"!==i&&this.map_.getLayers().some((t=>t.type===M.layer.type.OSM||t.type===M.layer.type.Mapbox))&&(u.attributes.map.bbox=this.getImpl().transformExt(u.attributes.map.bbox,i,"EPSG:3857"))}else!0===this.forceScale_&&(u.attributes.map.center=[o.x,o.y],u.attributes.map.scale=this.map_.getScale());return u}))}encodeLayers(){const t=this.map_.getLayers().filter((t=>!0===t.isVisible()&&!0===t.inRange()&&M.utils.isString(t.name)&&!t.name.startsWith("cluster_cover")));let e=t.length;return new Promise(((i,l)=>{let s=[];const n=[];t.forEach((t=>{this.getImpl().encodeLayer(t).then((l=>{if(M.utils.isNullOrEmpty(l)||"Vector"===l.type){const e=this.map_.getMapImpl().getView().getResolution(),i=t.getImpl().getOL3Layer().getMaxResolution();e>=t.getImpl().getOL3Layer().getMinResolution()&&e<=i&&n.push(l)}else s.push(l);e-=1,0===e&&(s=s.concat(n),i(s.reverse()))}))}))}))}encodeLegends(){const t=[];return this.map_.getLayers().forEach((e=>{if(!0===e.isVisible()&&!0===e.inRange()){const i=this.getImpl().encodeLegend(e);null!==i&&t.push(i)}}),this),t}createQueueElement(){const t=document.createElement("li");let e=this.inputTitle_.value;return M.utils.isNullOrEmpty(e)&&(e=o.NO_TITLE),t.innerHTML=e,t}dowloadPrint(t){t.preventDefault();const e=this.getAttribute(o.DOWNLOAD_ATTR_NAME);M.utils.isNullOrEmpty(e)||window.open(e,"_blank")}equals(t){let e=!1;return t instanceof o&&(e=this.name===t.name),e}}o.NAME="printercontrol",o.TEMPLATE="printer.html",o.LOADING_CLASS="printing",o.DOWNLOAD_ATTR_NAME="data-donwload-url-print",o.NO_TITLE="(Sin título)";const a=JSON.parse('{"Pu":{"uuid_plugin":"","uuid_version_plugin":"","version_ficha_metadatos":"","name":"Printer","description":"Tool for printing maps.","text":"","version":"4.2.2","date":"06/11/2023","author":"Junta de Andalucía","org":"Junta de Andalucía","tags":"mapea,plugin","icon":"./facade/assets/icons/icons.svg","buttons":[{"title":"","description":"","querySelector":""},{"title":"","description":"","querySelector":""}],"dependencies":{"modules":["",""],"plugins":[{"uuid":"","name":""}],"services":[{"name":"","description":""}]},"compatibility":["4","5","6"]}}');class r extends M.Plugin{constructor(t={}){super(null),this.map_=null,this.control_=null,this.panel_=null,this.name=r.NAME,M.utils.isUndefined(M.config.geoprint2)&&M.config("geoprint2",{URL:"https://geoprint-sigc.juntadeandalucia.es/geoprint3/print/SIGC",URL_APPLICATION:"https://geoprint-sigc.juntadeandalucia.es/geoprint3"}),this.url_=M.config.geoprint2.URL,M.utils.isNullOrEmpty(t.url)||(this.url_=t.url),this.params_={urlApplication:M.config.geoprint2.URL_APPLICATION,layout:{outputFilename:"mapea_${yyyy-MM-dd_hhmmss}"}},M.utils.isNullOrEmpty(t.params)||(this.params_=t.params,M.utils.isNullOrEmpty(this.params_.urlApplication)&&(this.params_.urlApplication=M.config.geoprint2.URL_APPLICATION),M.utils.isNullOrEmpty(this.params_.layout)&&(this.params_.layout={outputFilename:"mapea_${yyyy-MM-dd_hhmmss}"})),this.options_={},M.utils.isNullOrEmpty(t.options)||(this.options_=t.options),this.metadata_=a.Pu}addTo(t){this.map_=t,this.control_=new o(this.url_,this.params_,this.options_),this.panel_=new M.ui.Panel("printer",{collapsible:!0,className:"m-printer",collapsedButtonClass:"g-cartografia-impresora",position:M.ui.position.TR,tooltip:"Impresión del mapa"}),this.panel_.on(M.evt.ADDED_TO_MAP,(t=>{M.utils.enableTouchScroll(t)})),this.panel_.addControls(this.control_),this.map_.addPanels(this.panel_),this.control_.on(M.evt.ADDED_TO_MAP,(()=>{this.fire(M.evt.ADDED_TO_MAP)}))}getControls(){const t=[];return t.push(this.control_),t}destroy(){this.map_.removeControls([this.control_]),this.map_=null,this.control_=null,this.panel_=null,this.url_=null,this.params_=null,this.options_=null,this.name=null}equals(t){return t instanceof r}getAPIRest(){return`printer=${this.url_}`}getMetadata(){return this.metadata_}}r.NAME="printer",null==window.M.plugin&&(window.M.plugin={}),window.M.plugin.Printer=r})()})();