(()=>{var e={572:e=>{e.exports='<div class="m-control m-geosearch-container">\n  \x3c!-- search panel --\x3e\n  <div class="search-panel">\n    <input type="text" id="m-geosearch-search-input" placeholder="Buscar" class="m-input-search" />\n    <button id="m-geosearch-search-btn" class="g-cartografia-zoom m-search-btn" title="Buscar"></button>\n    <button id="m-geosearch-help-btn" class="g-cartografia-ayuda m-help-btn" title="Ayuda"></button>\n    <button id="m-geosearch-clear-btn" class="g-cartografia-cancelar m-clear-btn" title="Limpiar búsqueda"></button>\n  </div>\n  \x3c!-- results panel --\x3e\n  <div class="results-panel" id="m-geosearch-results">\n    <div id="m-searching-result" class="m-searching-result g-cartografia-spinner"></div>\n  </div>\n\n  <div class="m-hidden img-cache-loader" id="img-cache-loader">\n  </div>\n</div>'},369:e=>{e.exports='<div class="m-geosearch-content">\n   {{#each features}}\n   <div id="{{solrid}}" class="result">\n      {{#each attributes}}\n      <table>\n         <tr>\n            <td class="key">{{key}}</td>\n            <td class="value{{#oneword value}} m-wordbreak{{/oneword}}">{{{value}}}</td>\n         </tr>\n      </table>\n      {{/each}}\n   </div>\n   <div class="m-separator"></div>\n   {{/each}}\n</div>'},123:e=>{e.exports='<div class="m-geosearch-help">\n  {{#eq entities.length 0}}\n    <div class="entity">\n      <p>El servicio no tiene ayuda configurada</p>\n      <button id="m-geosearch-closeHelp-btn" class="g-cartografia-cancelar" title="Cerrar ayuda"></button>\n    </div>\n  {{/eq}}\n  {{#each entities}}\n    <div class="entity">\n      <button id="m-geosearch-closeHelp-btn" class="g-cartografia-cancelar m-clear-btn" title="Cerrar ayuda"></button>\n      <div class="name">{{entity}}</div>\n      <div class="info">{{info}}</div>\n      <ul class="keywords">\n        {{#each keywords}}\n          <li>{{this}}</li>\n        {{/each}}\n      </ul>\n      <div class="example">\n        <code>{{example}}</code>\n      </div>\n    </div>\n  {{/each}}\n</div>'},595:e=>{e.exports='<div class="results-panels">\n   {{#if partial}}\n   <div class="partial">\n      <p>No se han encontrado resultados para la búsqueda.</p>\n      <p>A continuación se muestran otros resultados que quizás le interesen:...</p>\n   </div>\n   {{/if}}\n   <div class="results" id="m-geosearch-results-scroll">\n      {{#each docs}}\n      <div id="{{solrid}}" class="result">\n         {{#each attributes}}\n         <table>\n            <tbody>\n               <tr>\n                  <td class="key">{{key}}</td>\n                  <td class="value{{#oneword value}} m-wordbreak{{/oneword}}">{{{value}}}</td>\n               </tr>\n            </tbody>\n         </table>\n         {{/each}}\n      </div>\n      {{/each}}\n   </div>\n   {{#eq docs.length 0}}\n   <div class="results">\n      <div class="partial">No se han encontrado resultados para la búsqueda "{{query}}".</div>\n   </div>\n   {{/eq}}\n   <div class="page">\n      <span class="found" id="m-geosearch-page-found">{{docs.length}}</span> de <span class="total">{{total}}</span>\n      <div class="g-cartografia-flecha-arriba"></div>\n   </div>\n</div>'},543:e=>{e.exports='<div class="m-control m-geosearchbylocation-container" id="m-geosearchbylocation-div" title="Geobúsquedas por geolocalización">\n   <button id="m-geosearchbylocation-button" class="g-cartografia-posicion7"></button>\n   <button id="m-geosearchbylocation-button-list" class="g-cartografia-lista hidden"></button>\n   \n   <div class="m-hidden img-cache-loader" id="img-cache-loader">\n   </div>\n</div>'},416:e=>{e.exports='<div class="m-geosearchbylocation-content">\n   <div>\n      <table>\n         <tr>\n            <td>X:</td>\n            <td>{{valorX}}</td>\n         </tr>\n         <tr>\n            <td>Y:</td>\n            <td>{{valorY}}</td>\n         </tr>\n      </table>\n   </div>\n</div>'},132:e=>{e.exports='<div class="m-geosearchbylocation-results-panel">\n   <div class="title">\n           B&uacute;squeda por localizaci&oacute;n\n            <button class="m-panel-btn"></button>\n    </div>\n   <div class="results" id="m-geosearchbylocation-results-scroll">\n      {{#each docs}}\n      <div id="{{solrid}}" class="result">\n         {{#each attributes}}\n         <table>\n            <tbody>\n               <tr>\n                  <td class="key">{{key}}</td>\n                  <td class="value">{{{value}}}</td>\n               </tr>\n            </tbody>\n         </table>\n         {{/each}}\n      </div>\n      {{/each}}\n   </div>\n   <div class="page">\n      <span class="total">{{total}} resultados.</span>\n   </div>\n</div>'}},t={};function s(l){var i=t[l];if(void 0!==i)return i.exports;var a=t[l]={exports:{}};return e[l](a,a.exports,s),a.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var l in t)s.o(t,l)&&!s.o(e,l)&&Object.defineProperty(e,l,{enumerable:!0,get:t[l]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";class e{static init(){if(!1===e.initialized){e.initialized=!0;const t=document.createElement("img");t.src=M.utils.concatUrlPaths([M.config.THEME_URL,"/img/m-pin-24.svg"]),t.width="24",t.height="24",t.crossOrigin="anonymous";const s=document.createElement("IMG");s.src=M.utils.concatUrlPaths([M.config.THEME_URL,"/img/m-pin-24-new.svg"]),s.width="24",s.height="24",s.crossOrigin="anonymous";const l=document.createElement("IMG");l.src=M.utils.concatUrlPaths([M.config.THEME_URL,"/img/m-pin-24-sel.svg"]),l.width="24",l.height="24",l.crossOrigin="anonymous",e.DEFAULT[M.geom.wkt.type.POINT]=new ol.style.Style({image:new ol.style.Icon({img:t})}),e.DEFAULT[M.geom.wkt.type.LINE_STRING]=new ol.style.Style({fill:new ol.style.Fill({color:"#A15BD7"}),stroke:new ol.style.Stroke({color:"#A15BD7",width:2})}),e.DEFAULT[M.geom.wkt.type.POLYGON]=new ol.style.Style({image:new ol.style.Icon({img:t})}),e.DEFAULT[M.geom.wkt.type.MULTI_POINT]=e.DEFAULT[M.geom.wkt.type.POINT],e.DEFAULT[M.geom.wkt.type.LINEAR_RING]=e.DEFAULT[M.geom.wkt.type.LINE_STRING],e.DEFAULT[M.geom.wkt.type.MULTI_LINE_STRING]=e.DEFAULT[M.geom.wkt.type.LINE_STRING],e.DEFAULT[M.geom.wkt.type.MULTI_POLYGON]=e.DEFAULT[M.geom.wkt.type.POLYGON],e.DEFAULT[M.geom.wkt.type.CIRCLE]=e.DEFAULT[M.geom.wkt.type.POLYGON],e.DEFAULT[M.geom.wkt.type.GEOMETRY_COLLECTION]=e.DEFAULT[M.geom.wkt.type.POLYGON],e.NEW[M.geom.wkt.type.POINT]=new ol.style.Style({image:new ol.style.Icon({img:s})}),e.NEW[M.geom.wkt.type.LINE_STRING]=new ol.style.Style({fill:new ol.style.Fill({color:"#e2951b"}),stroke:new ol.style.Stroke({color:"#e2951b",width:2})}),e.NEW[M.geom.wkt.type.POLYGON]=new ol.style.Style({image:new ol.style.Icon({img:s})}),e.NEW[M.geom.wkt.type.MULTI_POINT]=e.NEW[M.geom.wkt.type.POINT],e.NEW[M.geom.wkt.type.LINEAR_RING]=e.NEW[M.geom.wkt.type.LINE_STRING],e.NEW[M.geom.wkt.type.MULTI_LINE_STRING]=e.NEW[M.geom.wkt.type.LINE_STRING],e.NEW[M.geom.wkt.type.MULTI_POLYGON]=e.NEW[M.geom.wkt.type.POLYGON],e.NEW[M.geom.wkt.type.CIRCLE]=e.NEW[M.geom.wkt.type.POLYGON],e.NEW[M.geom.wkt.type.GEOMETRY_COLLECTION]=e.NEW[M.geom.wkt.type.POLYGON],e.SELECTED[M.geom.wkt.type.POINT]=new ol.style.Style({image:new ol.style.Icon({img:l})}),e.SELECTED[M.geom.wkt.type.LINE_STRING]=new ol.style.Style({fill:new ol.style.Fill({color:"#fcfcfc"}),stroke:new ol.style.Stroke({color:"#3589d1",width:2})}),e.SELECTED[M.geom.wkt.type.POLYGON]=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(240, 220, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#a15bd7",width:2})}),e.SELECTED[M.geom.wkt.type.MULTI_POINT]=e.SELECTED[M.geom.wkt.type.POINT],e.SELECTED[M.geom.wkt.type.LINEAR_RING]=e.SELECTED[M.geom.wkt.type.LINE_STRING],e.SELECTED[M.geom.wkt.type.MULTI_LINE_STRING]=e.SELECTED[M.geom.wkt.type.LINE_STRING],e.SELECTED[M.geom.wkt.type.MULTI_POLYGON]=e.SELECTED[M.geom.wkt.type.POLYGON],e.SELECTED[M.geom.wkt.type.CIRCLE]=e.SELECTED[M.geom.wkt.type.POLYGON],e.SELECTED[M.geom.wkt.type.GEOMETRY_COLLECTION]=e.SELECTED[M.geom.wkt.type.POLYGON]}}}e.DEFAULT={},e.NEW={},e.SELECTED={},e.initialized=!1;class t{static getCentroidCoordinate(e){let s,l,i,a,o,r;return e.getType()===M.geom.wkt.type.POINT?s=e.getCoordinates():e.getType()===M.geom.wkt.type.LINE_STRING||e.getType()===M.geom.wkt.type.LINEAR_RING?(l=e.getCoordinates(),i=Math.floor(l.length/2),s=l[i]):e.getType()===M.geom.wkt.type.POLYGON?s=t.getCentroidCoordinate(e.getInteriorPoint()):e.getType()===M.geom.wkt.type.MULTI_POINT?(a=e.getPoints(),i=Math.floor(a.length/2),s=t.getCentroidCoordinate(a[i])):e.getType()===M.geom.wkt.type.MULTI_LINE_STRING?(o=e.getLineStrings(),i=Math.floor(o.length/2),s=t.getCentroidCoordinate(o[i])):e.getType()===M.geom.wkt.type.MULTI_POLYGON?(a=e.getInteriorPoints(),s=t.getCentroidCoordinate(a)):e.getType()===M.geom.wkt.type.CIRCLE?s=e.getCenter():e.getType()===M.geom.wkt.type.GEOMETRY_COLLECTION&&(r=e.getGeometries(),i=Math.floor(r.length/2),s=t.getCentroidCoordinate(r[i])),s}}var l=s(369),i=s.n(l);class a extends M.impl.layer.Vector{constructor(e="geosearch",t={}){const s=t;super(s),this.wktFormatter_=new ol.format.WKT,this.popup_=null,this.selectedFeatures_=[],s.displayInLayerSwitcher||(s.displayInLayerSwitcher=!1),this.name=e}addTo(e){super.addTo(e),this.ol3Layer.setSource(new ol.source.Vector({useSpatialIndex:!1}))}drawResults(e){const t=ol.proj.get(this.map.getProjection().code);let s=[];M.utils.isNullOrEmpty(e.spatial_response)||(s=e.spatial_response.docs),M.utils.isNullOrEmpty(s)&&(s=e.response.docs);const l=s.map((e=>{const s=this.wktFormatter_.readFeature(e.geom,{dataProjection:t});return s.setId(e.solrid),s.setProperties(e),a.setStyleFeature(s,M.style.state.DEFAULT),this.wrapComplexFeature_(s),M.impl.Feature.olFeature2Facade(s)}),this);this.facadeVector_.addFeatures(l)}drawNewResults(e){const t=ol.proj.get(this.map.getProjection().code);let s;M.utils.isNullOrEmpty(e.spatial_response)?M.utils.isNullOrEmpty(e.response)||(s=e.response.docs):s=e.spatial_response.docs;const l=s.map((e=>{const s=this.wktFormatter_.readFeature(e.geom,{dataProjection:t});return s.setId(e.solrid),s.setProperties(e),a.setStyleFeature(s,M.style.state.NEW),M.impl.Feature.olFeature2Facade(s)}),this);this.facadeVector_.addFeatures(l)}clear(e){this.map.removePopup(),this.facadeVector_.clear()}selectFeatures(e,t,s,l){let o=e;this.unselectFeatures(),this.selectedFeatures_=o,o=o.map(M.impl.Feature.facade2OLFeature),a.setStyleFeature(o,M.style.state.SELECTED);const r={jsonp:!0,vars:this.parseFeaturesForTemplate_(o),parseToHtml:!1},n={icon:"g-cartografia-pin",title:"Geosearch",content:M.template.compileSync(i(),r)};let c=this.map.getPopup();M.utils.isNullOrEmpty(c)?(c=new M.Popup({panMapIfOutOfView:!l,ani:null}),c.addTab(n),this.map.addPopup(c,t)):c.addTab(n),c.on(M.evt.DESTROY,(()=>{this.internalUnselectFeatures_(!0)}),this)}selectFeatureBySolrid(e){const s=this.facadeVector_.getFeatureById(e);this.selectedFeatures_=[s];const l=s.getImpl().getOLFeature().getGeometry(),i=t.getCentroidCoordinate(l);this.unselectFeatures(),this.selectFeatures([s],i,null,!0),this.map.setBbox(l.getExtent())}parseFeaturesForTemplate_(e){const t={features:[]};return e.forEach((e=>{const s=["geom","_version_","keywords","solrid",e.getGeometryName()],l=e.getProperties(),i=[];Object.keys(l).forEach((e=>{M.utils.includes(s,e.toLowerCase())||i.push({key:M.utils.beautifyAttributeName(e),value:l[e]})}));const a={solrid:e.getId(),attributes:i};t.features.push(a)})),t}wrapComplexFeature_(e){const t=e.getGeometry();if(t.getType()===M.geom.wkt.type.POLYGON||t.getType()===M.geom.wkt.type.MULTI_POLYGON){let s;s=t.getType()===M.geom.wkt.type.POLYGON?t.getInteriorPoint():t.getInteriorPoints();const l=new ol.geom.GeometryCollection([s,t]);e.setGeometry(l)}}unselectFeatures(e,t){this.internalUnselectFeatures_()}internalUnselectFeatures_(e){this.selectedFeatures_.length>0&&(a.setStyleFeature(this.selectedFeatures_.map(M.impl.Feature.facade2OLFeature),M.style.state.DEFAULT),this.selectedFeatures_.length=0,e||this.map.removePopup())}setNewResultsAsDefault(){a.setStyleFeature(this.facadeVector_.getFeatures().map(M.impl.Feature.facade2OLFeature),M.style.state.DEFAULT)}getCentroidCoordinate(e){let t,s,l,i,a,o;return e.getType()===M.geom.wkt.type.POINT?t=e.getCoordinates():e.getType()===M.geom.wkt.type.LINE_STRING||e.getType()===M.geom.wkt.type.LINEAR_RING?(s=e.getCoordinates(),l=Math.floor(s.length/2),t=s[l]):e.getType()===M.geom.wkt.type.POLYGON?t=this.getCentroidCoordinate(e.getInteriorPoint()):e.getType()===M.geom.wkt.type.MULTI_POINT?(i=e.getPoints(),l=Math.floor(i.length/2),t=this.getCentroidCoordinate(i[l])):e.getType()===M.geom.wkt.type.MULTI_LINE_STRING?(a=e.getLineStrings(),l=Math.floor(a.length/2),t=this.getCentroidCoordinate(a[l])):e.getType()===M.geom.wkt.type.MULTI_POLYGON?(i=e.getInteriorPoints(),t=this.getCentroidCoordinate(i)):e.getType()===M.geom.wkt.type.CIRCLE?t=e.getCenter():e.getType()===M.geom.wkt.type.GEOMETRY_COLLECTION&&(o=e.getGeometries(),l=Math.floor(o.length/2),t=this.getCentroidCoordinate(o[l])),t}destroy(){const e=this.map.getMapImpl();M.utils.isNullOrEmpty(this.ol3Layer)||(e.removeLayer(this.ol3Layer),this.ol3Layer=null),this.map=null,this.wktFormatter_=null,this.popup_=null,this.selectedFeatures_=null,this.name=null}equals(e){let t=!1;return e instanceof a&&(t=this.url===e.url,t=t&&this.name===e.name),t}static setStyleFeature(t,s){let l=t;e.init(),M.utils.isArray(l)||(l=[l]),l.forEach((t=>{const l=t.getGeometry().getType();M.utils.isNullOrEmpty(s)||s===M.style.state.DEFAULT?t.setStyle(e.DEFAULT[l]):s===M.style.state.NEW?t.setStyle(e.NEW[l]):s===M.style.state.SELECTED&&t.setStyle(e.SELECTED[l])}))}}a.POPUP_RESULT="geosearchfeaturepopup.html";class o extends M.layer.Vector{constructor(e={},t={},s=new a){super(e,t,{},s),M.utils.isUndefined(a)&&M.exception("La implementación usada no puede crear capas Geosearch"),this.displayInLayerSwitcher=!1}equals(e){return!1}}class r extends M.impl.Control{constructor(e={}){super(),this.facadeMap_=null,this.helpHtml_=null,this.layer_=new o({name:e.layerName||"__geosearch_plugin_layer_name__"})}addTo(e,t){this.facadeMap_=e,e.addLayers(this.layer_),super.addTo(e,t)}unselectResults(e){this.layer_.getImpl().unselectFeatures(e)}setNewResultsAsDefault(){this.layer_.getImpl().setNewResultsAsDefault()}drawResults(e){this.layer_.getImpl().drawResults(e)}drawNewResults(e){this.layer_.getImpl().drawNewResults(e)}zoomToResults(){const e=ol.extent.boundingExtent(this.layer_.getImpl().getOLLayer().getSource().getFeatures().map((e=>ol.extent.getCenter(e.getGeometry().getExtent()))));this.facadeMap_.setBbox(e)}getLayer(){return this.layer_}resultClick(e){this.layer_.getImpl().selectFeatureBySolrid(e)}hideHelp(){M.utils.isNullOrEmpty(this.helpHtml_)||(this.facadeMap_.getMapImpl().getTargetElement().removeChild(this.helpHtml_),this.helpHtml_=null)}showHelp(e){const t=this.facadeMap_.getMapImpl().getTargetElement();M.utils.isNullOrEmpty(this.helpHtml_)||t.removeChild(this.helpHtml_),this.helpHtml_=e,t.appendChild(this.helpHtml_)}clear(){this.layer_.clear()}destroy(){this.clear(),this.facadeMap_.areasContainer.getElementsByClassName("m-top m-right")[0].classList.remove("top-extra"),this.facadeMap_.getMapImpl().removeControl(this),this.facadeMap_=null,this.helpHtml_=null,this.layer_=null}}var n=s(572),c=s.n(n),h=s(595),u=s.n(h),p=s(123),d=s.n(p);class m extends M.Control{constructor(e,t,s,l,i){super(new r,m.NAME),M.utils.isUndefined(r)&&M.exception("La implementación usada no puede crear controles Geosearch"),this.input_=null,this.element_=null,this.resultsContainer_=null,this.resultsScrollContainer_=null,this.searchingResult_=null,this.searchTime_=0,this.url_=e,this.core_=t,this.handler_=s,this.searchUrl_=M.utils.concatUrlPaths([this.url_,this.core_,this.handler_]),this.helpUrl_=M.utils.concatUrlPaths([this.url_,this.core_,"/help"]),this.searchParameters_=l,M.utils.isNullOrEmpty(this.searchParameters_)||(M.utils.isNullOrEmpty(this.searchParameters_.rows)&&(this.searchParameters_.rows=M.config.GEOSEARCH_ROWS),this.searchUrl_=M.utils.addParameters(this.searchUrl_,this.searchParameters_)),this.results_=[],this.showHelp_=i,this.scrollIsUp_=!0,this.spatialSearch_=!1,this.facadeMap_=null}createView(e){this.facadeMap_=e;const t=M.template.compileSync(c(),{jsonp:!0});return!1===this.showHelp_&&t.querySelector("#m-geosearch-help-btn").classList.add("m-hidden"),this.addEvents(t),this.createImagesCache(t),t}createImagesCache(e){console.log(e);const t=e.getElementsByClassName("img-cache-loader")[0];["/img/m-pin-24.svg","/img/m-pin-24-new.svg","/img/m-pin-24-sel.svg"].forEach((e=>{let s=new Image;s.src=M.utils.concatUrlPaths([M.config.THEME_URL,e]),s.width="24",s.height="24",s.crossOrigin="anonymous",t.append(s)}))}addEvents(e){this.element_=e,this.on(M.evt.COMPLETED,(()=>{this.element_.classList.add("shown")}),this),this.input_=this.element_.getElementsByTagName("input")["m-geosearch-search-input"],this.input_.addEventListener("keyup",this.searchClick.bind(this)),this.element_.getElementsByTagName("button")["m-geosearch-search-btn"].addEventListener("click",this.searchClick.bind(this));const t=this.element_.getElementsByTagName("button")["m-geosearch-help-btn"];t&&t.addEventListener("click",(e=>{e.preventDefault(),t.classList.toggle("shown"),this.helpClick_()})),this.element_.getElementsByTagName("button")["m-geosearch-clear-btn"].addEventListener("click",this.clearClick_.bind(this)),this.resultsContainer_=this.element_.querySelector("div#m-geosearch-results"),M.utils.enableTouchScroll(this.resultsContainer_),this.searchingResult_=this.element_.querySelector("div#m-geosearch-results > div#m-searching-result")}addEventsHelp(e){this.element_=e,this.element_.getElementsByTagName("button")["m-geosearch-closeHelp-btn"].addEventListener("click",this.closeHelpClick_.bind(this))}searchClick(e){if(e.preventDefault(),"keyup"!==e.type||13===e.keyCode){this.results_.length=0;const e=this.input_.value;M.utils.isNullOrEmpty(e)?M.dialog.info("Debe introducir una búsqueda."):this.search_(e,this.showResults_)}}resultClick_(e){const t=e;t.preventDefault(),M.window.WIDTH<=M.config.MOBILE_WIDTH&&this.resultsContainer_.querySelector("div.page > div.g-cartografia-flecha-arriba").click(),this.facadeMap_.removePopup();const s=t.currentTarget.id;this.getImpl().resultClick(s)}search_(e,t){this.resultsContainer_.appendChild(this.searchingResult_),this.searchTime_=Date.now(),this.element_.classList.add(m.SEARCHING_CLASS);const s=M.utils.addParameters(this.searchUrl_,{q:e,start:this.results_.length,srs:this.facadeMap_.getProjection().code});(e=>{M.remote.get(s).then((s=>{if(e===this.searchTime_){let e;try{e=JSON.parse(s.text)}catch(e){M.exception(`La respuesta no es un JSON válido: ${e}`)}t.call(this,e),this.element_.classList.remove(m.SEARCHING_CLASS)}}))})(this.searchTime_)}showResults_(e){this.getImpl().clear(),this.drawResults(e);const t={jsonp:!0,vars:this.parseResultsForTemplate_(e)},s=M.template.compileSync(u(),t);this.resultsContainer_.classList.remove(m.HIDDEN_RESULTS_CLASS),M.utils.isNullOrEmpty(this.resultsScrollContainer_)||this.resultsScrollContainer_.removeEventListener("scroll",this.resultsScroll_);let l,i=this.resultsContainer_.querySelectorAll(".result");for(let e=0,t=i.length;e<t;e+=1)l=i.item(e),l.removeEventListener("click",this.resultClick_.bind(this));e.response.docs.length>0&&this.zoomToResults();let a=this.resultsContainer_.querySelector("div.page > div.g-cartografia-flecha-arriba");M.utils.isNullOrEmpty(a)||a.removeEventListener("click",this.resultsClick_.bind(this)),this.resultsContainer_.innerHTML=s.innerHTML,this.resultsScrollContainer_=this.resultsContainer_.querySelector("div#m-geosearch-results-scroll"),M.utils.enableTouchScroll(this.resultsScrollContainer_),this.resultsScrollContainer_.addEventListener("scroll",this.resultsScroll_.bind(this)),i=this.resultsContainer_.getElementsByClassName("result");for(let e=0,t=i.length;e<t;e+=1)l=i.item(e),l.addEventListener("click",this.resultClick_.bind(this));a=this.resultsContainer_.querySelector("div.page > div.g-cartografia-flecha-arriba"),a.addEventListener("click",this.resultsClick_.bind(this)),this.checkScrollSearch_(e),this.fire(M.evt.COMPLETED)}drawResults(e){this.getImpl().drawResults(e)}drawNewResults(e){this.getImpl().drawNewResults(e)}zoomToResults(){this.getImpl().zoomToResults()}getInput(){return this.input_}appendResults_(e){this.drawNewResults(e);const t={jsonp:!0,vars:this.parseResultsForTemplate_(e,!0)},s=M.template.compileSync(u(),t).getElementsByTagName("div")["m-geosearch-results-scroll"].children;for(let e=0;e<s.length;e+=1){const t=s.item(e);this.resultsScrollContainer_.appendChild(t),t.addEventListener("click",(e=>this.resultClick_(e)))}this.resultsContainer_.getElementsByTagName("span")["m-geosearch-page-found"].innerHTML=this.results_.length,this.checkScrollSearch_(e)}resultsScroll_(e){const t=e.target,s=t.offsetHeight,l=t.scrollHeight-t.scrollTop-s<=15;l&&this.scrollIsUp_?(this.scrollIsUp_=!1,this.scrollSearch_()):l||(this.scrollIsUp_=!0)}scrollSearch_(){this.getImpl().unselectResults(!0),this.getImpl().setNewResultsAsDefault();const e=this.input_.value;this.search_(e,this.appendResults_)}helpClick_(e){!0===this.helpShown_?(this.getImpl().hideHelp(),this.helpShown_=!1):M.remote.get(this.helpUrl_).then((e=>{let t;try{t=JSON.parse(e.text)}catch(e){M.Exception(`La respuesta no es un JSON válido: ${e}`)}const s={jsonp:!0,vars:{entities:t}},l=M.template.compileSync(d(),s);this.addEventsHelp(l),this.getImpl().showHelp(l),this.helpShown_=!0}))}closeHelpClick_(e){!0===this.helpShown_&&(this.getImpl().hideHelp(),this.helpShown_=!1)}clearClick_(e){this.element_.classList.remove("shown"),M.utils.isNullOrEmpty(this.input_)||(this.input_.value=""),M.utils.isNullOrEmpty(this.resultsContainer_)||(this.resultsContainer_.innerHTML=""),M.utils.isNullOrEmpty(this.resultsScrollContainer_)||(this.resultsScrollContainer_.innerHTML="",this.resultsScrollContainer_=null),this.results_.length=0,this.resultsContainer_.classList.remove(m.HIDDEN_RESULTS_CLASS),this.getImpl().clear(),this.getImpl().hideHelp(),this.spatialSearch_=!1}resultsClick_(e){this.facadeMap_.areasContainer.getElementsByClassName("m-top m-right")[0].classList.add("top-extra-search"),e.target.classList.toggle("g-cartografia-flecha-arriba"),e.target.classList.toggle("g-cartografia-flecha-abajo"),this.resultsContainer_.classList.toggle(m.HIDDEN_RESULTS_CLASS)}equals(e){let t=!1;return e instanceof m&&(t=this.name===e.name),t}parseResultsForTemplate_(e,t){let s="";M.utils.isNullOrEmpty(this.input_)||(s=this.input_.value);let l=0;M.utils.isUndefined(e.spatial_response)?(l=e.response.numFound,this.spatialSearch_=!1):(l=e.spatial_response.numFound,this.spatialSearch_=!0);const i=this.getDocsFromResults_(e);this.results_=!0===t?this.results_.concat(i):i;const a=this.spatialSearch_&&M.utils.isNullOrEmpty(e.spatial_response.docs);let o=null;return o=0!==l?{docs:i,total:l,partial:a}:{docs:i,total:l,notResutls:!0,query:s},o}getDocsFromResults_(e){let t=[];t=this.spatialSearch_?e.spatial_response.docs:e.response.docs;const s=["geom","_version_","keywords","solrid"];return t=t.map((e=>{const t=[];return Object.keys(e).forEach((l=>{M.utils.includes(s,l)||t.push({key:M.utils.beautifyAttributeName(l),value:e[l]})})),{solrid:e.solrid,attributes:t}})),t}checkScrollSearch_(e){let t=0;t=M.utils.isUndefined(e.spatial_response)?e.response.numFound:e.spatial_response.numFound,this.results_.length!==t||M.utils.isNullOrEmpty(this.resultsScrollContainer_)||this.resultsScrollContainer_.removeEventListener("scroll",this.resultsScroll_)}}m.NAME="geosearch",m.TEMPLATE="geosearch.html",m.RESULTS_TEMPLATE="geosearchresults.html",m.HELP_TEMPLATE="geosearchhelp.html",m.SEARCHING_CLASS="m-searching",m.HIDDEN_RESULTS_CLASS="hidden";var g=s(416),_=s.n(g);class y extends r{constructor(e){super({layerName:y.NAME}),this.popup_=null,this.searchUrl_=e}setMap(e){super.setMap(e),M.utils.isNullOrEmpty(e)?this.facadeMap_.getImpl().removeFeatures([this.positionFeature_]):this.map=e}locate(){const e=new ol.Geolocation({projection:this.facadeMap_.getMapImpl().getView().getProjection()});let t;return e.setTracking(!0),this.positionFeature_=M.impl.Feature.olFeature2Facade(new ol.Feature),this.positionFeature_.getImpl().getOLFeature().setStyle(new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#3399CC"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})})),this.positionFeature_.click=e=>{const s={jsonp:!0,vars:{valorX:t[0],valorY:t[1]},parseToHtml:!1},l={icon:"g-cartografia-gps2",title:"posición",content:M.template.compileSync(_(),s)};this.popup_=this.facadeMap_.getPopup(),M.utils.isNullOrEmpty(this.popup_)?(this.popup_=new M.Popup,this.popup_.addTab(l),this.facadeMap_.addPopup(this.popup_,t)):this.popup_.addTab(l)},new Promise(((s,l)=>{e.on("change:position",(()=>{e.setTracking(!1),t=e.getPosition(),s(t)}),this)}))}removeLocate(){this.facadeMap_.removeFeatures([this.positionFeature_])}drawLocation(e){this.positionFeature_.getImpl().getOLFeature().setGeometry(e?new ol.geom.Point(e):null),this.facadeMap_.drawFeatures([this.positionFeature_])}addResultsContainer(e){this.map.getTargetElement().appendChild(e)}removeResultsContainer(e){null!==e&&null!=e.parentElement&&e.parentElement.removeChild(e)}zoomToResultsAll(){const e=this.facadeMap_.getControls("geosearchbylocation")[0].getImpl().getLayer().getFeaturesExtent();this.facadeMap_.setBbox(e)}destroy(){this.facadeMap_.getMapImpl().removeControl(this),this.clear(),this.facadeMap_.removeFeatures([this.positionFeature_]),this.popup_=null,this.searchUrl_=null}}y.POPUP_LOCATION="geosearchbylocationfeaturepopup.html";var E=s(543),L=s.n(E),w=s(132),C=s.n(w);class T extends m{constructor(e,t,s,l,i,a){super(e,t,s),this.impl_=new y(this.searchUrl_),this.activate_=!0,this.activatebtnList_=!0,this.distance_=l,this.spatialField_=i,this.rows_=a,this.searchUrl_=M.utils.concatUrlPaths([e,t,s]),this.facadeMap_=null,this.resultsScrollContainer_=null,M.utils.isUndefined(y)&&M.Exception("La implementación usada no puede crear controles Geosearchbylocation"),this.name=T.NAME}equals(e){let t=!1;return e instanceof T&&(t=this.name===e.name),t}createView(e){this.facadeMap_=e;const t=M.template.compileSync(L(),{jsonp:!0});return this.createImagesCache(t),t}createImagesCache(e){console.log(e);const t=e.getElementsByClassName("img-cache-loader")[0];["/img/m-pin-24.svg","/img/m-pin-24-new.svg","/img/m-pin-24-sel.svg"].forEach((e=>{let s=new Image;s.src=M.utils.concatUrlPaths([M.config.THEME_URL,e]),s.width="24",s.height="24",s.crossOrigin="anonymous",t.append(s)}))}getActivationButton(e){return e.querySelector("button#m-geosearchbylocation-button")}activate(){this.element_.classList.add("activated"),this.element_.classList.add(m.SEARCHING_CLASS),this.getImpl().locate().then((e=>{const t=new ol.geom.Point(e),s=(new ol.format.WKT).writeGeometry(t);this.searchFrom_(s,e)}))}deactivate(){this.element_.classList.remove("activated"),this.getImpl().clear(),this.getImpl().removeLocate(),this.getImpl().removeResultsContainer(this.resultsContainer_)}drawLocation_(e){this.getImpl().drawLocation(e)}searchFrom_(e,t){let s=null;s=M.utils.addParameters(this.searchUrl_,{wt:"json",pt:e,q:"*:*",start:0,d:this.distance_,spatialField:this.spatialField_,rows:this.rows_,srs:this.map_.getProjection().code}),this.searchTime_=Date.now(),(e=>{M.remote.get(s).then((s=>{if(e===this.searchTime_){let e;try{e=JSON.parse(s.text)}catch(e){M.Exception(`La respuesta no es un JSON válido:${e}`)}this.showResults_(e),this.drawLocation_(t),this.zoomToResultsAll_(),this.activationBtn_.classList.remove(m.HIDDEN_RESULTS_CLASS),this.element_.classList.remove(m.SEARCHING_CLASS)}}))})(this.searchTime_)}zoomToResultsAll_(){this.getImpl().zoomToResultsAll()}showResults_(e){this.getImpl().clear(),this.results=e,this.showList=!0,this.drawResults(e),this.element_.querySelector("button#m-geosearchbylocation-button-list").onclick=this.showList_.bind(this)}showList_(){if(!0===this.showList){const e={jsonp:!0,vars:this.parseResultsForTemplate_(this.results)},t=M.template.compileSync(C(),e);this.resultsContainer_=t,this.resultsScrollContainer_=this.resultsContainer_.querySelector("div#m-geosearchbylocation-results-scroll"),M.utils.enableTouchScroll(this.resultsScrollContainer_),this.getImpl().addResultsContainer(this.resultsContainer_);const s=this.resultsContainer_.getElementsByClassName("result");for(let e=0,t=s.length;e<t;e+=1)s.item(e).addEventListener("click",(e=>{this.resultClick_(e),this.getImpl().removeResultsContainer(this.resultsContainer_),this.showList=!0}));t.querySelector(".title > button.m-panel-btn").addEventListener("click",this.showList_.bind(this)),this.showList=!1}else this.getImpl().removeResultsContainer(this.resultsContainer_),this.showList=!0}resultsClick_(e){this.resultsContainer_.classList.toggle(m.HIDDEN_RESULTS_CLASS)}}T.NAME="geosearchbylocation",T.HIDDEN="hidden",T.TEMPLATE="geosearchbylocation.html",T.RESULTS_TEMPLATE="geosearchbylocationresults.html";const N=JSON.parse('{"Pu":{"uuid_plugin":"","uuid_version_plugin":"","version_ficha_metadatos":"","name":"GeosearchByLocation","description":"Search for locations within a given radius from a location user.","text":"","version":"2.0.3","date":"11/10/2019","author":"Junta de Andalucía","org":"Junta de Andalucía","tags":"mapea,plugin","icon":"./facade/assets/icons/icons.svg","buttons":[{"title":"","description":"","querySelector":""},{"title":"","description":"","querySelector":""}],"dependencies":{"modules":["",""],"plugins":[{"uuid":"","name":""}],"services":[{"name":"","description":""}]},"compatibility":["4","5","6"]}}');class v extends M.Plugin{constructor(e={}){super(),this.name=v.NAME,this.url_=M.config.GEOSEARCH_URL,M.utils.isNullOrEmpty(e.url)||(this.url_=e.url),this.core_=M.config.GEOSEARCH_CORE,M.utils.isNullOrEmpty(e.core)||(this.core_=e.core),this.handler_=M.config.GEOSEARCH_HANDLER,M.utils.isNullOrEmpty(e.handler)||(this.handler_=e.handler),this.distance_=M.config.GEOSEARCH_DISTANCE,M.utils.isNullOrEmpty(e.distance)||(this.distance_=e.distance),this.spatialField_=M.config.GEOSEARCH_SPATIAL_FIELD,this.rows_=M.config.GEOSEARCHBYLOCATION_ROWS,this.map_=null,this.controlGeo_=null,this.panel_=null,this.metadata_=N.Pu}addTo(e){this.map_=e,this.controlGeo_=new T(this.url_,this.core_,this.handler_,this.distance_,this.spatialField_,this.rows_),this.controlGeo_.on(M.evt.ADDED_TO_MAP,(()=>{this.fire(M.evt.ADDED_TO_MAP)})),this.panel_=new M.ui.Panel(v.NAME,{collapsible:!1,className:"m-geosearchbylocation",position:M.ui.position.BR});const t=e.getPanels([M.control.Location.NAME])[0];let s;M.utils.isNullOrEmpty(t)||M.utils.isNullOrEmpty(s)?M.utils.isNullOrEmpty(t)?M.utils.isNullOrEmpty(s)||(s.addClassName("m-with-geosearchbylocation"),this.panel_.addClassName("m-with-streetview")):(t.addClassName("m-with-geosearchbylocation"),this.panel_.addClassName("m-with-location")):(t.addClassName("m-with-geosearchbylocation"),s.addClassName("m-with-geosearchbylocation"),this.panel_.addClassName("m-with-location m-with-streetview")),this.panel_.addControls(this.controlGeo_),this.map_.addPanels(this.panel_)}destroy(){this.map_.removeControls([this.controlGeo_]),this.controlGeo_=null,this.name=null,this.url_=null,this.core_=null,this.handler_=null,this.distance_=null,this.spatialField_=null,this.rows_=null,this.map_=null,this.controlGeo_=null,this.panel_=null}getControls(){const e=[];return e.push(this.controlGeo_),e}equals(e){return e instanceof v}getAPIRest(){return`geosearchbylocation=${this.distance_}*${this.url_}*${this.core_}*${this.handler_}`}getMetadata(){return this.metadata_}}v.NAME="geosearchbylocation",null==window.M.plugin&&(window.M.plugin={}),window.M.plugin.Geosearchbylocation=v})()})();